(()=>{"use strict";var __webpack_modules__=[,(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{let Browser,Platform;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Browser:()=>Browser,Platform:()=>Platform,UserAgent:()=>UserAgent,default:()=>__WEBPACK_DEFAULT_EXPORT__}),function(Browser){Browser[Browser.Unknown=0]="Unknown",Browser[Browser.Generic=1]="Generic",Browser[Browser.Chrome=2]="Chrome",Browser[Browser.Firefox=3]="Firefox",Browser[Browser.Safari=4]="Safari"}(Browser||(Browser={})),function(Platform){Platform[Platform.Unknown=0]="Unknown",Platform[Platform.GenericDesktop=1]="GenericDesktop",Platform[Platform.GenericMobile=2]="GenericMobile",Platform[Platform.IOS=3]="IOS",Platform[Platform.Android=4]="Android",Platform[Platform.MacOS=5]="MacOS",Platform[Platform.Windows=6]="Windows",Platform[Platform.Linux=7]="Linux"}(Platform||(Platform={}));class UserAgent{constructor(userAgentString){let platform=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.navigator.platform;this.rawUA=userAgentString,this.rawPlatform=platform,this.parse()}uaContains(wanted){return-1!==this.rawUA.indexOf(wanted)}platformContains(wanted){return-1!==this.rawPlatform.indexOf(wanted)}isDesktop(){switch(this.platform){case Platform.GenericDesktop:case Platform.MacOS:case Platform.Windows:case Platform.Linux:return!0;default:return!1}}isMobile(){switch(this.platform){case Platform.GenericMobile:case Platform.IOS:case Platform.Android:return!0;default:return!1}}isVAPIDPotentiallySupported(){return(this.isDesktop()||this.platform===Platform.Android)&&(this.browser===Browser.Chrome||this.browser===Browser.Firefox)}parse(){if(this.browser=Browser.Unknown,this.uaContains("Edge/")||this.uaContains("Trident/"))return this.browser=Browser.Generic,void(this.platform=Platform.Windows);if(this.uaContains("iPhone")||this.uaContains("iPad")||this.uaContains("CriOS"))return this.browser=Browser.Generic,void(this.platform=Platform.IOS);if(this.uaContains("Android")?this.platform=Platform.Android:(this.uaContains("Mobi")||this.uaContains("Tablet"))&&(this.platform=Platform.GenericMobile),this.platform!==Platform.Android&&(this.platform=Platform.GenericDesktop),this.platform===Platform.GenericDesktop&&(this.platformContains("Mac")?this.platform=Platform.MacOS:this.platformContains("Win")?this.platform=Platform.Windows:(this.platformContains("Linux")||this.platformContains("X11"))&&(this.platform=Platform.Linux)),this.uaContains("Chrome/")||this.uaContains("Chromium/"))return this.browser=Browser.Chrome,void(this.platform===Platform.Android&&(this.uaContains("; wv")||this.uaContains("(wv;")||this.uaContains("Chrome/30.0.0.0")||this.uaContains("Chrome/33.0.0.0"))&&(this.browser=Browser.Generic));if(this.uaContains("Firefox/"))this.browser=Browser.Firefox;else if(this.uaContains("Version/")&&this.platform===Platform.Android)this.browser=Browser.Generic;else{if(this.uaContains("Safari/"))return this.browser=Browser.Safari,void(this.platform===Platform.GenericDesktop&&(this.platform=Platform.MacOS));this.browser=Browser.Unknown,this.platform===Platform.GenericDesktop&&(this.platform=Platform.Unknown)}}}const __WEBPACK_DEFAULT_EXPORT__=UserAgent},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SDK_API_LVL:()=>SDK_API_LVL,SDK_VERSION:()=>SDK_VERSION,SDK_MAJOR_VERSION:()=>SDK_MAJOR_VERSION,SDK_DISMISS_NOTIF_AFTER:()=>SDK_DISMISS_NOTIF_AFTER,RETRY_MAX_ATTEMPTS:()=>RETRY_MAX_ATTEMPTS,RETRY_MIN_INTERVAL_MS:()=>RETRY_MIN_INTERVAL_MS,SSL_SCRIPT_URL:()=>SSL_SCRIPT_URL,WS_URL:()=>WS_URL,SAFARI_WS_URL:()=>SAFARI_WS_URL,ICONS_URL:()=>ICONS_URL,IS_DEV:()=>IS_DEV,IS_TEST:()=>IS_TEST,IS_WEBPACK_DEV_SERVER:()=>IS_WEBPACK_DEV_SERVER});const SDK_API_LVL="1",SDK_VERSION="3.5.0",SDK_MAJOR_VERSION="3",SDK_DISMISS_NOTIF_AFTER=30,RETRY_MAX_ATTEMPTS=3,RETRY_MIN_INTERVAL_MS=1e3,SSL_SCRIPT_URL="via.batch.com",WS_URL="https://ws.batch.com/web",SAFARI_WS_URL="https://safari-ws.batch.com",ICONS_URL="https://icons.batch.com",IS_DEV=!1,IS_TEST=!1,IS_WEBPACK_DEV_SERVER=!1},,(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{LogLevel:()=>LogLevel,Log:()=>Log});var _config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_helpers_window__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5);let LogLevel;!function(LogLevel){LogLevel[LogLevel.None=0]="None",LogLevel[LogLevel.Public=1]="Public",LogLevel[LogLevel.PublicError=2]="PublicError",LogLevel[LogLevel.Error=3]="Error",LogLevel[LogLevel.Warn=4]="Warn",LogLevel[LogLevel.Info=5]="Info",LogLevel[LogLevel.Trace=6]="Trace",LogLevel[LogLevel.Debug=7]="Debug"}(LogLevel||(LogLevel={}));const Log=new class{constructor(){this.level=LogLevel.PublicError,this.enabledModules=new Set,this.disabledModules=new Set,this.name="SDK",this.enabledModules.add("public"),this.loadStorageSettings(),_config__WEBPACK_IMPORTED_MODULE_0__.IS_DEV&&this.addGlobalEventListeners()}loadStorageSettings(){const safeWindow=(0,_helpers_window__WEBPACK_IMPORTED_MODULE_1__.default)();if(null!=safeWindow&&"object"==typeof safeWindow.localStorage){"1"===safeWindow.localStorage.getItem("com.batch.private.logger.listeners")&&this.addGlobalEventListeners();const rawLevel=safeWindow.localStorage.getItem("com.batch.private.logger.level");if(null!=rawLevel){const level=+rawLevel;level>=0&&level<=7&&(this.level=level)}try{const rawEnabledModules=safeWindow.localStorage.getItem("com.batch.private.logger.modules.enabled");if(rawEnabledModules){const enabledModules=JSON.parse(rawEnabledModules);Array.isArray(enabledModules)&&enabledModules.forEach(m=>{this.enableModule(m)})}const rawDisabledModules=safeWindow.localStorage.getItem("com.batch.private.logger.modules.disabled");if(rawDisabledModules){const disabledModules=JSON.parse(rawDisabledModules);Array.isArray(disabledModules)&&disabledModules.forEach(m=>{this.disableModule(m)})}}catch(_){}}}addGlobalEventListeners(){const safeWindow=(0,_helpers_window__WEBPACK_IMPORTED_MODULE_1__.default)();null!=safeWindow&&(safeWindow.addEventListener("___batchSDK___.logger.enableModule",e=>this.enableModule(e.module)),safeWindow.addEventListener("___batchSDK___.logger.disableModule",e=>this.disableModule(e.module)),safeWindow.addEventListener("___batchSDK___.logger.setLogLevel",e=>{let levelValue;switch(e.level.toLowerCase()){case"none":levelValue=0;break;case"public":levelValue=1;break;case"publicerror":levelValue=2;break;case"error":levelValue=3;break;case"warn":levelValue=4;break;case"info":levelValue=5;break;case"trace":levelValue=6;break;case"debug":default:levelValue=7}this.level=levelValue}))}enableModule(module){this.enabledModules.add(module.toLowerCase())}enableTunneling(to){this.tunnelingTo=to}disableModule(module){this.disabledModules.add(module.toLowerCase())}isModuleEnabled(module){const m=module.toLowerCase();return!this.disabledModules.has(m)&&(this.enabledModules.has("*")||this.enabledModules.has(m))}shouldLogForLevel(wantedLevel){return this.level>0&&wantedLevel<=this.level}logMethodForLevel(wantedLevel){let method;switch(wantedLevel){case LogLevel.Public:method=console.log;break;case LogLevel.PublicError:case LogLevel.Error:method=console.error;break;case LogLevel.Info:method=console.info;break;case LogLevel.Warn:method=console.warn;break;case LogLevel.Trace:method=console.trace;break;case LogLevel.Debug:default:method=console.debug}return method||console.log}getGroupMethod(){return console.group}getGroupEndMethod(){return console.groupEnd}formatPrefix(moduleName){return"public"===moduleName?"Batch":"Batch "+this.name+" ["+moduleName+"]"}public(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.log(LogLevel.Public,"public",...args)}publicError(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];this.log(LogLevel.PublicError,"public",...args)}error(module){for(var _len3=arguments.length,args=new Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)args[_key3-1]=arguments[_key3];this.log(LogLevel.Error,module,...args)}warn(module){for(var _len4=arguments.length,args=new Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++)args[_key4-1]=arguments[_key4];this.log(LogLevel.Warn,module,...args)}info(module){for(var _len5=arguments.length,args=new Array(_len5>1?_len5-1:0),_key5=1;_key5<_len5;_key5++)args[_key5-1]=arguments[_key5];this.log(LogLevel.Info,module,...args)}trace(module){for(var _len6=arguments.length,args=new Array(_len6>1?_len6-1:0),_key6=1;_key6<_len6;_key6++)args[_key6-1]=arguments[_key6];this.log(LogLevel.Trace,module,...args)}debug(module){for(var _len7=arguments.length,args=new Array(_len7>1?_len7-1:0),_key7=1;_key7<_len7;_key7++)args[_key7-1]=arguments[_key7];this.log(LogLevel.Debug,module,...args)}log(level,moduleName){for(var _len8=arguments.length,args=new Array(_len8>2?_len8-2:0),_key8=2;_key8<_len8;_key8++)args[_key8-2]=arguments[_key8];if(this.tunnelingTo){const a=[];args.forEach(v=>{switch(typeof v){case"number":case"string":case"boolean":a.push(v);break;case"object":try{a.push(v?"["+v.toString()+"]":null)}catch(e){a.push("[No toString method]")}break;default:a.push("[Unsupported type "+typeof v+"]")}})}level!==LogLevel.Public&&level!==LogLevel.PublicError||(moduleName="public"),this.isModuleEnabled(moduleName)&&this.shouldLogForLevel(level)&&this.logMethodForLevel(level).apply(console,[this.formatPrefix(moduleName)+" -",...args])}grouped(level,module,groupTitle,lines){if(this.isModuleEnabled(module)&&this.shouldLogForLevel(level)){groupTitle?this.getGroupMethod().apply(console,[this.formatPrefix(module)+" -",groupTitle]):this.getGroupMethod().apply(console,[this.formatPrefix(module)]);const logMethod=this.logMethodForLevel(level);lines.forEach(l=>logMethod.apply(console,[l])),this.getGroupEndMethod().apply(console,[])}}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function safeGetWindow(){return"object"==typeof window?window:null}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>safeGetWindow})},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>newPublicAPI});var com_batch_dom_sdk_impl_sdk_factory__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(7),com_batch_dom_ui_translator__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(57),com_batch_dom_ui_uicomponent_handler__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(61),com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(46),com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(23),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(24),com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(27),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(4),_config__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(2);var TypedEventAttributeType,UserAttributeType;function newPublicAPI(){let originalConfig;const ready=new Promise(resolve=>{"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?resolve():(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.debug("public-api","Waiting for DOM to be ready"),window.addEventListener("DOMContentLoaded",()=>{resolve()},!0))}).then(()=>{com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.debug("public-api","DOM is ready")});let instance=null;function getInstance(){return(instance||Promise.reject("Batch is not initialized yet. Have you called 'setup' before calling Batch's API?")).catch(e=>{throw"Batch SDK: Could not initialize Public API: "+e})}const eventBus=com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_5__.LocalEventBus,uiComponents=new com_batch_dom_ui_uicomponent_handler__WEBPACK_IMPORTED_MODULE_2__.UIComponentHandler;let setupCalled=!1;const api={setup:config=>{if(setupCalled)return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.publicError("'setup' cannot be called twice. Ignoring.");setupCalled=!0,originalConfig=(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_3__.default)(config);const uiConfig=(config=(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_3__.default)(config)).ui;uiConfig&&"string"==typeof uiConfig.language&&((0,com_batch_dom_ui_translator__WEBPACK_IMPORTED_MODULE_1__.default)().setLanguage(uiConfig.language),delete uiConfig.language);const origin=document.location.origin.toLowerCase(),sdkConfig=Object.assign({},config,{internal:{origin:origin.startsWith("http")?origin:null,referrer:document.location.href.toLowerCase()},ui:null});if(window.isSecureContext||com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.warn("public-api","Insecure origin: notification push will not work."),sdkConfig.sameOrigin)throw new Error('Remove "sameOrigin" from the SDK configuration, or downgrade the SDK to the previous major version.');if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_4__.asBoolean)(sdkConfig.dev,!1)&&com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.public("Starting version "+_config__WEBPACK_IMPORTED_MODULE_8__.SDK_VERSION+" in development mode.","Environment: Fully secure"),instance=ready.then(async()=>(await(0,com_batch_dom_sdk_impl_sdk_factory__WEBPACK_IMPORTED_MODULE_0__.createSDKFactory)()).setup(sdkConfig)),window&&sdkConfig.enableHashFeatures){window.addEventListener("hashchange",e=>{if(e.newURL){const url=new URL(e.newURL);""!==url.hash&&com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_5__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_6__.default.HashChanged,{hash:url.hash},!0)}});const currentHash=window.location.hash;""!==currentHash&&com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_5__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_6__.default.HashChanged,{hash:currentHash},!0),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.debug("Core","Hash features have been enabled by configuration, listening to 'hashchange'.")}instance.then(async sdk=>{await sdk.start();const uiReady=uiComponents.init(uiConfig||{});sdk.getInstallationID().then(iid=>{sdkConfig.dev&&com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.public("Installation ID: "+(iid||"unknown"))});const subPromise=sdk.getSubscriptionState();uiReady.catch(e=>com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.warn("public-api","Error while initializing the ui :",e)).then(()=>subPromise).then(state=>com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_5__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_6__.default.UiReady,state,!1))}).catch(e=>com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_7__.Log.error("public-api","Error while initiliazing batch SDK :",e))},getConfiguration:()=>(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_3__.default)(originalConfig),refreshServiceWorkerRegistration:()=>getInstance().then(sdk=>sdk.refreshServiceWorkerRegistration()),setCustomUserID:identifier=>getInstance().then(sdk=>sdk.setCustomUserID(identifier)),getCustomUserID:()=>getInstance().then(sdk=>sdk.getCustomUserID()),setUserLanguage:language=>getInstance().then(sdk=>sdk.setLanguage(language)),getUserLanguage:()=>getInstance().then(sdk=>sdk.getLanguage()),setUserRegion:region=>getInstance().then(sdk=>sdk.setRegion(region)),getUserRegion:()=>getInstance().then(sdk=>sdk.getRegion()),getInstallationID:()=>getInstance().then(sdk=>sdk.getInstallationID()),isSubscribed:()=>getInstance().then(sdk=>sdk.isSubscribed()),getNotificationPermission:()=>getInstance().then(sdk=>sdk.getPermission()),subscribe:()=>getInstance().then(sdk=>sdk.subscribe()),unsubscribe:()=>getInstance().then(sdk=>sdk.unsubscribe()),tryToSubscribeFrom:state=>{if(null==state)return Promise.reject("No state given");let p=Promise.resolve(!1);return p=state.subscribed?api.isSubscribed():api.subscribe(),p},getSubscription:()=>getInstance().then(sdk=>sdk.getSubscription()),getSubscriptionState:()=>getInstance().then(sdk=>sdk.getSubscriptionState()),doesExistingSubscriptionKeyMatchCurrent:()=>getInstance().then(sdk=>sdk.doesExistingSubscriptionKeyMatchCurrent()),on:(eventCode,callback)=>{eventBus.subscribe(eventCode,(detail,evt)=>callback(api,detail,evt))},trackEvent:(name,params)=>getInstance().then(sdk=>sdk.trackEvent(name,params)),eventAttributeTypes:Object.freeze(TypedEventAttributeType),userAttributeTypes:Object.freeze(UserAttributeType),editUserData:callback=>{getInstance().then(sdk=>{sdk.editUserData(callback)})},getUserAttributes:async()=>getInstance().then(sdk=>sdk.getUserAttributes()),getUserTagCollections:async()=>getInstance().then(sdk=>sdk.getUserTagCollections()),ui:{register:(code,init)=>{uiComponents.add(code,(function(config){const compConfigWithTrans=(0,com_batch_dom_ui_translator__WEBPACK_IMPORTED_MODULE_1__.default)().populateDefaultComponentText(config,code);return compConfigWithTrans.popin=(0,com_batch_dom_ui_translator__WEBPACK_IMPORTED_MODULE_1__.default)().populateDefaultComponentText(compConfigWithTrans.popin||{},"popin"),init(api,compConfigWithTrans,component=>{com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_5__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_6__.default.UiComponentDrawn,{code:code,component:component},!1)})}))},registerAfter:(dependencies,code,init)=>{const waitingFor=new Set(dependencies);0===waitingFor.size?api.ui.register(code,init):eventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_6__.default.UiComponentReady,cready=>{waitingFor.delete(cready.code)&&0===waitingFor.size&&api.ui.register(code,init)})},get:code=>{const c=uiComponents.getComponent(code);return null!=c?c.component:null},has:code=>uiComponents.getComponentState(code)===com_batch_dom_ui_uicomponent_handler__WEBPACK_IMPORTED_MODULE_2__.UIComponentState.LOADED,waitUntilDrawn:componentCode=>uiComponents.waitUntilDrawn(componentCode),show:(componentCode,force)=>(force=force||!1,api.ui.waitUntilDrawn(componentCode).then(c=>{"function"==typeof c.show&&c.show(force)})),hide:componentCode=>api.ui.waitUntilDrawn(componentCode).then(c=>{"function"==typeof c.hide&&c.hide()}),showPublicIdentifiers:()=>uiComponents.showPublicIdentifiers()}};return api}!function(TypedEventAttributeType){TypedEventAttributeType.STRING="s",TypedEventAttributeType.BOOLEAN="b",TypedEventAttributeType.INTEGER="i",TypedEventAttributeType.FLOAT="f",TypedEventAttributeType.DATE="t",TypedEventAttributeType.URL="u"}(TypedEventAttributeType||(TypedEventAttributeType={})),function(UserAttributeType){UserAttributeType.STRING="s",UserAttributeType.BOOLEAN="b",UserAttributeType.INTEGER="i",UserAttributeType.FLOAT="f",UserAttributeType.DATE="t",UserAttributeType.URL="u"}(UserAttributeType||(UserAttributeType={}))},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{createSDKFactory:()=>createSDKFactory});var com_batch_dom_sdk_impl_sdk_safari__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(8),com_batch_dom_sdk_impl_sdk_standard__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(54),com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(29),com_batch_shared_parameters_parameter_store__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(31);async function createSDKFactory(){let sdkFactory=com_batch_dom_sdk_impl_sdk_standard__WEBPACK_IMPORTED_MODULE_1__.default;if(new com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_2__.default(window.navigator.userAgent).browser===com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_2__.Browser.Safari)if("PushManager"in self){const parameterStore=await com_batch_shared_parameters_parameter_store__WEBPACK_IMPORTED_MODULE_4__.default.getInstance(),subscription=await parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__.keysByProvider.profile.Subscription);subscription&&"string"==typeof subscription&&(sdkFactory=com_batch_dom_sdk_impl_sdk_safari__WEBPACK_IMPORTED_MODULE_0__.default)}else sdkFactory=com_batch_dom_sdk_impl_sdk_safari__WEBPACK_IMPORTED_MODULE_0__.default;return sdkFactory}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SafariSDK:()=>SafariSDK,default:()=>__WEBPACK_DEFAULT_EXPORT__});var com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(4),_sdk__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(9),_sdk_base__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(10),com_batch_shared_helpers_timed_promise__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(15);function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}class SafariSDK extends _sdk_base__WEBPACK_IMPORTED_MODULE_3__.default{constructor(){super(...arguments),_defineProperty(this,"syncSubscription",async remotePermission=>{if(remotePermission.permission===_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Denied){if(await this.isSubscribed())return this.unsubscribe()}if(remotePermission.permission===_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Granted){const subscription=await this.getSubscription();if(!subscription||subscription!==remotePermission.deviceToken){const newSubscription=remotePermission.deviceToken;return newSubscription&&this.updateSubscription(newSubscription,!0),this.isSubscribed()}}return Promise.resolve(!1)}),_defineProperty(this,"getAllowedDomain",safari=>{const origin=window.location.origin.toString().toLowerCase(),allowedDomain=Object.keys(safari).find(allowedDomain=>origin===allowedDomain);if(!allowedDomain)throw new Error("Current website ".concat(origin," is not present in the 'safari' configuration object"));return allowedDomain}),_defineProperty(this,"fetchDiagnostics",async()=>{const response=await fetch("".concat(com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__.SAFARI_WS_URL,"/").concat(this.config.apiKey,"/1.0/diagnostics/").concat(this.websitePushID),{method:"POST",body:JSON.stringify({installId:this.installID})});return await response.json()}),_defineProperty(this,"printDiagnostics",async()=>{try{var _ref;const response=await Promise.race([this.fetchDiagnostics(),(0,com_batch_shared_helpers_timed_promise__WEBPACK_IMPORTED_MODULE_4__.Timeout)(1e4)]);if(!response)throw new Error("Invalid diagnostics server response");if("FAIL"===response.status)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.publicError(null!==(_ref="[Diagnostics] "+(null==response?void 0:response.error))&&void 0!==_ref?_ref:"Unknown server error");if("OK"===response.status)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.info("sdk-safari","User has denied permission")}catch(err){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.publicError("[Diagnostics] Cannot diagnose registration issue: Internal server error"),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.error("sdk-safari","Source error: "+err)}}),_defineProperty(this,"requestSafariPermission",async()=>{if("safari"in window&&"pushNotification"in window.safari&&this.websitePushID){const websitePushID=this.websitePushID,currentPermission=window.safari.pushNotification.permission(websitePushID);if(currentPermission.permission!==_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Default)return this.getSubscriptionTokenAndPrintStatus(currentPermission);const callbackWorkaround=this.waitUntilUserRepliedToPermissionPrompt(websitePushID);com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","Requesting safari permission");const safariCallbackPromise=new Promise(resolve=>{window.safari.pushNotification.requestPermission("".concat(com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__.SAFARI_WS_URL,"/").concat(this.config.apiKey),websitePushID,{installID:this.installID},permission=>{callbackWorkaround.cancel(),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","Got safari permission callback: ",JSON.stringify(permission)),resolve(this.getSubscriptionTokenAndPrintStatus(permission))})});return Promise.race([safariCallbackPromise,callbackWorkaround.promise])}return null}),_defineProperty(this,"waitUntilUserRepliedToPermissionPrompt",websitePushID=>{let shouldCancel=!1;return{cancel:()=>{shouldCancel=!0},promise:new Promise(resolve=>{let permissionAttemptsLeft=80;const handle=setInterval(()=>{if(shouldCancel||permissionAttemptsLeft<=0)return void clearInterval(handle);permissionAttemptsLeft--;const permission=window.safari.pushNotification.permission(websitePushID);permission.permission!==_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Default&&(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","Got safari permission using pull: ",JSON.stringify(permission)),clearInterval(handle),resolve(this.getSubscriptionTokenAndPrintStatus(permission)))},500)})}}),_defineProperty(this,"getSubscriptionTokenAndPrintStatus",cachedPermission=>{if("safari"in window&&"pushNotification"in window.safari&&this.websitePushID){const{permission:permission,deviceToken:deviceToken}=cachedPermission||window.safari.pushNotification.permission(this.websitePushID);if(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","getSubscriptionTokenAndPrintStatus: permission",permission,"deviceToken",deviceToken,"NotifPermission",window.Notification.permission),permission===_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Default)return null;if(permission===_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Denied&&window.Notification.permission===_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Denied)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.info("sdk-safari","User denied permission"),null;if(permission==_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Denied&&window.Notification.permission!==_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Denied)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.info("sdk-safari","Unknown state: requesting diagnostics"),this.printDiagnostics(),null;if(permission===_sdk__WEBPACK_IMPORTED_MODULE_2__.Permission.Granted)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.info("sdk-safari","User granted permission"),null!=deviceToken?deviceToken:null}return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.public("sdk-safari","Safari push notifications are not supported in this environment"),null})}async setup(sdkConfig){if(await super.setup(sdkConfig),null==window)throw new Error("Not in a browser page. is it a service worker?");try{if(void 0===sdkConfig.safari)throw new Error("Missing safari configuration");const configWebsitePushID=sdkConfig.safari[this.getAllowedDomain(sdkConfig.safari)];if(!("string"==typeof configWebsitePushID&&configWebsitePushID.length>=0))throw new Error("No valid website push ID for current host in safari configuration");this.websitePushID=configWebsitePushID;try{this.installID=await this.getInstallationID()}catch(e){throw new Error("Could not get installID")}}catch(e){throw await this.startSessionIfNeeded(),e}return this}async start(){if(await super.start(),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","Tyring to resubscribe for "+this.websitePushID),this.websitePushID){const remotePermission=window.safari.pushNotification.permission(this.websitePushID);try{await this.syncSubscription(remotePermission)}catch(_unused){throw new Error("Could not synchronize subscription status with remote")}}}async refreshServiceWorkerRegistration(){}async doesExistingSubscriptionKeyMatchCurrent(){return!0}sanitizeSubscription(subscription){if("string"==typeof subscription||subscription instanceof String)return subscription;com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","Invalid subscription, sanitizing. (",subscription+")")}getTokenForEventParameter(){return this.lastSubscription?{protocol:"APNS",subscription:{deviceToken:this.lastSubscription,websitePushId:this.websitePushID}}:null}async subscribe(){if(!this.getSubscriptionTokenAndPrintStatus()||!this.lastSubscribed){const currentSubscription=await this.requestSafariPermission();await this.updateSubscription(currentSubscription,null!==currentSubscription);const subscribed=await this.isSubscribed();return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.debug("sdk-safari","Reading subscribed:",subscribed),subscribed}return Promise.resolve(!1)}async unsubscribe(){return super.unsubscribe()}readPermission(){return null!=window&&this.websitePushID?Promise.resolve(window.safari.pushNotification.permission(this.websitePushID).permission):Promise.reject("Internal error (no window or websitePushID available, is the SDK setup finished?)")}}const __WEBPACK_DEFAULT_EXPORT__=new class{constructor(){this.instance=null}setup(config){if(null==this.instance){const sdkConfig=Object.assign({},config);com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.info("sdk-safari","Instantiating a new SDK");const sdk=new SafariSDK;this.instance=sdk.setup(sdkConfig).then(()=>sdk)}else com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_1__.Log.warn("sdk-safari","Config cannot be set again once the SDK has already been started");return this.instance||Promise.reject("Setup failed")}getInstance(){return this.instance||Promise.reject("You must setup the SDK before using it")}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{let Permission;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Permission:()=>Permission}),function(Permission){Permission.Default="default",Permission.Granted="granted",Permission.Denied="denied"}(Permission||(Permission={}))},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>BaseSDK});var com_batch_shared_event_event__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(11),com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(13),com_batch_shared_event_event_tracker__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(14),com_batch_shared_event_public_event__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(21),com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(23),com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(1),com_batch_shared_helpers_uuid__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(12),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(24),com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(27),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(4),com_batch_shared_managers_probation_manager__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(28),com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(29),com_batch_shared_parameters_parameter_store__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(31),com_batch_shared_persistence_user_data__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(39),com_batch_shared_user_event_data__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(40),com_batch_shared_user_user_attribute_editor__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(42),com_batch_shared_user_user_module__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(43),com_batch_shared_webservice_executor__WEBPACK_IMPORTED_MODULE_17__=__webpack_require__(53),_sdk__WEBPACK_IMPORTED_MODULE_18__=__webpack_require__(9);class BaseSDK{constructor(){var obj,key,value;value=(current,last)=>current!==last&&(null==current||null==last||current===typeof Object&&last===typeof Object&&(null==current?void 0:current.endpoint)!=(null==last?void 0:last.endpoint)),(key="hasSubscriptionChanged")in(obj=this)?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_7__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_8__.default.ExitedProbation,this.onProbationChanged.bind(this)),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_7__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_8__.default.DataChanged,this.onDataChanged.bind(this))}onProbationChanged(){var _this$eventTracker;com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.info("sdk-base","Probation changed : "+com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.FirstSubscription+" sent"),null===(_this$eventTracker=this.eventTracker)||void 0===_this$eventTracker||_this$eventTracker.track(new com_batch_shared_event_event__WEBPACK_IMPORTED_MODULE_0__.default(com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.FirstSubscription))}onDataChanged(){var _this$eventTracker2;com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.info("sdk-base","Data changed : "+com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.InstallDataChanged+" sent"),null===(_this$eventTracker2=this.eventTracker)||void 0===_this$eventTracker2||_this$eventTracker2.track(new com_batch_shared_event_event__WEBPACK_IMPORTED_MODULE_0__.default(com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.InstallDataChanged))}async setup(sdkConfig){try{if(this.config=Object.assign({},sdkConfig),!this.config.apiKey)throw new Error("Configuration error: 'apiKey' is mandatory");if(!this.config.authKey)throw new Error("Configuration error: 'authKey' is mandatory");this.config.dev=(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_4__.asBoolean)(this.config.dev,!1);const parameterStore=await com_batch_shared_parameters_parameter_store__WEBPACK_IMPORTED_MODULE_12__.default.getInstance();this.parameterStore=parameterStore,parameterStore.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.LastConfiguration,this.config);try{null==await parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.InstallationID)&&this.createInstallationID()}catch(e){this.createInstallationID()}let referrer;if(this.config.internal&&this.config.internal.referrer&&(referrer=this.config.internal.referrer),this.webserviceExecutor=new com_batch_shared_webservice_executor__WEBPACK_IMPORTED_MODULE_17__.default(this.config.apiKey,this.config.authKey,this.config.dev,referrer,parameterStore),this.probationManager=new com_batch_shared_managers_probation_manager__WEBPACK_IMPORTED_MODULE_10__.ProbationManager(parameterStore),this.eventTracker=new com_batch_shared_event_event_tracker__WEBPACK_IMPORTED_MODULE_2__.default(this.config.dev,this.webserviceExecutor),this.userModule=new com_batch_shared_user_user_module__WEBPACK_IMPORTED_MODULE_16__.UserModule(this.probationManager,await com_batch_shared_persistence_user_data__WEBPACK_IMPORTED_MODULE_13__.UserDataPersistence.getInstance(),this.webserviceExecutor),new com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_5__.UserAgent(window.navigator.userAgent).browser!==com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_5__.Browser.Safari)try{if(null!==window&&void 0!==window.navigator&&"permissions"in window.navigator){(await window.navigator.permissions.query({name:"notifications"})).addEventListener("change",this.checkUpdate.bind(this))}else com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.warn("sdk-base","Cannot listen to permission changes: API unavailable")}catch(e){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.warn("sdk-base","Error while listening to permission changes (not a fatal error)",e)}return null!=window&&(new com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_5__.UserAgent(window.navigator.userAgent).browser===com_batch_shared_helpers_user_agent__WEBPACK_IMPORTED_MODULE_5__.Browser.Firefox&&window.setInterval(this.checkUpdate.bind(this),5e3),window.addEventListener("focus",this.checkUpdate.bind(this))),this}catch(e){throw com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.error("sdk-base","Error while initializing the sdk",e),new Error("Error while initializing the sdk")}}async start(){const stPromise=this.parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscription).then(s=>this.lastSubscription=s),sdPromise=this.parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscribed).then(s=>this.lastSubscribed=!0===s);this.lastSubscription=this.sanitizeSubscription(this.lastSubscription),await Promise.all([stPromise,sdPromise]),this.lastPermission=await this.readPermission(),this.lastState={permission:this.lastPermission||_sdk__WEBPACK_IMPORTED_MODULE_18__.Permission.Default,subscribed:this.lastSubscribed||!1},await this.startSessionIfNeeded()}async clearSession(){const store=await this.getParameterStore();await store.removeParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.session.SessionID)}async startSessionIfNeeded(){const store=await this.getParameterStore();if(null===await store.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.session.SessionID)){var _this$eventTracker3;const sessionID=(0,com_batch_shared_helpers_uuid__WEBPACK_IMPORTED_MODULE_6__.default)();return await store.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.session.SessionID,sessionID),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.info("sdk-base","New session : "+com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.Start+" sent","with sub",this.lastSubscription),null===(_this$eventTracker3=this.eventTracker)||void 0===_this$eventTracker3||_this$eventTracker3.track(new com_batch_shared_event_event__WEBPACK_IMPORTED_MODULE_0__.default(com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.Start,{token:this.getTokenForEventParameter()})),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_7__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_8__.default.SessionStarted,{sessionID:sessionID},!0),!0}return!1}getParameterStore(){return null!=this.parameterStore?Promise.resolve(this.parameterStore):Promise.reject("parameter store null")}async createInstallationID(){const parameterStore=await this.getParameterStore();return await parameterStore.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.InstallationID,(0,com_batch_shared_helpers_uuid__WEBPACK_IMPORTED_MODULE_6__.default)())}async bumpProfileVersion(){const parameterStore=await this.getParameterStore(),version=await parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.UserProfileVersion),intVal=null==version?NaN:parseInt(version,10);return await parameterStore.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.UserProfileVersion,isNaN(intVal)?0:intVal+1),!0}async setProfileParameter(key,identifier){const definedIdentifier=void 0===identifier?null:identifier,parameterStore=await this.getParameterStore();return await parameterStore.setOrRemoveParameterValueIfChanged(key,definedIdentifier)&&this.bumpProfileVersion().then(()=>{this.eventTracker&&this.eventTracker.track(new com_batch_shared_event_event__WEBPACK_IMPORTED_MODULE_0__.default(com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.ProfileChanged)),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_7__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_8__.default.ProfileChanged,{[key]:definedIdentifier},!0)}),definedIdentifier}async setCustomUserID(identifier){return await this.setProfileParameter(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.CustomIdentifier,identifier),void 0===identifier?null:identifier}setLanguage(lang){return this.setProfileParameter(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.UserLanguage,lang)}setRegion(lang){return this.setProfileParameter(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.UserRegion,lang)}async getCustomUserID(){const p=await this.getParameterStore();return await p.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.CustomIdentifier)}async getLanguage(){const p=await this.getParameterStore();return await p.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.UserLanguage)}async getRegion(){const p=await this.getParameterStore();return await p.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.UserRegion)}async getInstallationID(){const parameterStore=await this.getParameterStore(),installID=await parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.InstallationID);if(null!=installID)return installID;throw new Error("Invalid internal state")}async isSubscribed(){return!("granted"!==await this.getPermission()||!await this.readAndCheckSubscribed())&&this.getSubscription().then(sub=>null!=sub)}async getPermission(){const perm=await this.readPermission();return await this.updatePermission(perm)}readPermission(){return null!=window&&null!=window.Notification?Promise.resolve(window.Notification.permission):Promise.reject("Internal error (no window available)")}async subscribe(){if("granted"===await this.getPermission())return this.updateSubscribed(!0),this.isSubscribed();throw new Error("Permission denied")}async unsubscribe(){return await this.updateSubscribed(!1),!await this.isSubscribed()}getSubscription(){return this.readAndCheckSubscription()}async getSubscriptionState(){return{permission:await this.getPermission(),subscribed:await this.isSubscribed()}}async trackEvent(name,eventDataParams){try{var _this$eventTracker4;const eventData=new com_batch_shared_user_event_data__WEBPACK_IMPORTED_MODULE_14__.EventData(eventDataParams);null===(_this$eventTracker4=this.eventTracker)||void 0===_this$eventTracker4||_this$eventTracker4.track(new com_batch_shared_event_public_event__WEBPACK_IMPORTED_MODULE_3__.PublicEvent(name,await this.probationManager.isInProbation(),eventData))}catch(e){return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.error("sdk-base",e)}}async editUserData(callback){if("function"!=typeof callback)return;if(!this.userModule)return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.error("sdk-base","Internal error (no user module available)");const editor=new com_batch_shared_user_user_attribute_editor__WEBPACK_IMPORTED_MODULE_15__.UserAttributeEditor;callback(editor),editor._markAsUnusable();try{this.userModule.editUserData(editor)}catch(e){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.error("sdk-base",e)}}async getUserAttributes(){if(this.userModule)return this.userModule.getPublicAttributes();throw new Error("Internal error (no user module available)")}async getUserTagCollections(){if(this.userModule)return this.userModule.getPublicTagCollections();throw new Error("Internal error (no user module available)")}async checkUpdate(){await this.getSubscriptionState()}sanitizeSubscription(subscription){return subscription}async readAndCheckSubscribed(){let sub=await(await this.getParameterStore()).getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscribed);sub=!0===sub;const last=this.lastSubscribed;return last!==sub&&(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.info("sdk-base","Subscribed updated from "+last+" to "+sub),this.lastSubscribed=sub,this.subscriptionChanged(!0)),sub}async readAndCheckSubscription(){let currentSubscription=await(await this.getParameterStore()).getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscription);currentSubscription=this.sanitizeSubscription(currentSubscription);const lastSubscription=this.lastSubscription;return this.hasSubscriptionChanged(currentSubscription,lastSubscription)&&(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.info("sdk-base","Subscription updated",currentSubscription),this.lastSubscription=currentSubscription,this.subscriptionChanged(!0)),currentSubscription}async updateSubscribed(subscribed){return(await this.getParameterStore()).setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscribed,subscribed),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.debug("sdk-base","Writring subscribed:",subscribed),this.readAndCheckSubscribed()}async updateSubscription(sub,subscribed){const parameterStore=await this.getParameterStore();return void 0===sub||null==sub?await parameterStore.removeParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscription):await parameterStore.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscription,sub),"boolean"==typeof subscribed&&(parameterStore.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscribed,subscribed),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_9__.Log.debug("sdk-base","Writring subscribed:",subscribed)),this.readAndCheckSubscription()}async updatePermission(perm){return this.lastPermission!==perm&&(this.lastPermission=perm,this.subscriptionChanged(!1)),perm}async subscriptionChanged(){let tokenChanged=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const state=await this.getSubscriptionState();if((tokenChanged||!this.lastState||this.lastState.subscribed!==state.subscribed)&&this.eventTracker){const params={token:this.getTokenForEventParameter()};this.config.internal&&this.config.internal.referrer&&(params.referrer=this.config.internal.referrer),this.eventTracker.track(new com_batch_shared_event_event__WEBPACK_IMPORTED_MODULE_0__.default(state.subscribed?com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.Subscribed:com_batch_shared_event_event_names__WEBPACK_IMPORTED_MODULE_1__.InternalSDKEvent.Unsubscribed,params));const p=await this.getParameterStore();await p.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_11__.keysByProvider.profile.Subscribed,state.subscribed)}this.lastState=state,com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_7__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_8__.default.SubscriptionChanged,state,!0)}getTokenForEventParameter(){return this.lastSubscription?{protocol:"WPP",subscription:this.lastSubscription}:null}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>Event});var _helpers_uuid__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(12);class Event{constructor(name,params){if("string"!=typeof name)throw new Error("Error while constructing Event: 'name' is required and should be a string");if(this.id=(0,_helpers_uuid__WEBPACK_IMPORTED_MODULE_0__.default)(),this.name=name.toUpperCase(),this.date=new Date,null!=params&&"object"!=typeof params)throw new Error("Error while constructing Event: 'params' is optional but must be an object if provided");this.params=params||{}}toJSON(){return{id:this.id,name:this.name,date:this.date.toISOString(),params:this.params}}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>uuid});const supportsPRNG=void 0!==self.crypto&&void 0!==self.crypto.getRandomValues;function uuid(){const randomNumbers=new Array(31);if(supportsPRNG){const prngRandomBytes=new Uint8Array(randomNumbers.length);self.crypto.getRandomValues(prngRandomBytes);for(let i=0;i<randomNumbers.length;i+=1)randomNumbers[i]=prngRandomBytes[i]%16|0}else for(let i=0;i<randomNumbers.length;i+=1)randomNumbers[i]=16*Math.random()|0;randomNumbers[15]=3&randomNumbers[15]|8;let uuidString="";for(let i=0;i<randomNumbers.length;i+=1)uuidString+=randomNumbers[i].toString(16),7===i||14===i||18===i?uuidString+="-":11===i&&(uuidString+="-4");return uuidString}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{let InternalSDKEvent;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{InternalSDKEvent:()=>InternalSDKEvent}),function(InternalSDKEvent){InternalSDKEvent.ProfileChanged="_PROFILE_CHANGED",InternalSDKEvent.Start="_START",InternalSDKEvent.Subscribed="_SUBSCRIPTION",InternalSDKEvent.Unsubscribed="_UNSUBSCRIPTION",InternalSDKEvent.PushOpen="_OPEN_PUSH",InternalSDKEvent.FirstSubscription="_FIRST_SUBSCRIPTION",InternalSDKEvent.InstallDataChanged="_INSTALL_DATA_CHANGED"}(InternalSDKEvent||(InternalSDKEvent={}))},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>EventTracker});var _config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_helpers_timed_promise__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(15),_logger__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(4),_webservice_event_tracker__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(16),_webservice_http_error__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(20);function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}class EventTracker{constructor(dev,webserviceExecutor){_defineProperty(this,"debounceDelay",200),_defineProperty(this,"limit",30),this.dev=dev,this.buffer=[],this.webserviceExecutor=webserviceExecutor,this.attemptRunning=!1,this.lastForbiddenLog=0}track(event){_logger__WEBPACK_IMPORTED_MODULE_2__.Log.debug("Event Tracker","Tracking event '".concat(event.name,"'")),this.buffer.push(event),this.debounceSend&&clearTimeout(this.debounceSend),this.debounceSend=self.setTimeout(()=>{this.send()},this.debounceDelay)}send(){let retryCount=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(0===retryCount&&this.attemptRunning||0===this.buffer.length)return!1;const sortedBuffer=this.buffer.sort((a,b)=>"_"===a.name.charAt(0)?-1:"_"===b.name.charAt(0)?1:0),eventsToSend=sortedBuffer.slice(0,this.limit);return this.buffer=sortedBuffer.slice(this.limit,sortedBuffer.length),this.attemptRunning=!0,this.webserviceExecutor.start(new _webservice_event_tracker__WEBPACK_IMPORTED_MODULE_3__.EventTrackerService(eventsToSend)).then(()=>{this.attemptRunning=!1,this.buffer=this.buffer.filter(b=>!(null!=eventsToSend&&eventsToSend.map(e=>e.id).includes(b.id))),this.send()}).catch(e=>{this.buffer=eventsToSend.concat(this.buffer),retryCount+=1,retryCount<_config__WEBPACK_IMPORTED_MODULE_0__.RETRY_MAX_ATTEMPTS?(0,_helpers_timed_promise__WEBPACK_IMPORTED_MODULE_1__.Delay)(_config__WEBPACK_IMPORTED_MODULE_0__.RETRY_MIN_INTERVAL_MS).then(()=>{this.send(retryCount)}):(this.attemptRunning=!1,e instanceof _webservice_http_error__WEBPACK_IMPORTED_MODULE_4__.default&&(401===e.response.status||403===e.response.status)&&Date.now()-this.lastForbiddenLog>1e4&&this.logForbiddenError())}),!0}logForbiddenError(){this.lastForbiddenLog=Date.now(),_logger__WEBPACK_IMPORTED_MODULE_2__.Log.publicError("Error: Could not authenticate against Batch's servers");let log="Is your configuration 'apiKey'/'authKey' pair correct?";this.dev&&(log+=" In development mode, you also need to add the current origin to 'allowed dev origins' in the dashboard under 'Push Settings'"),_logger__WEBPACK_IMPORTED_MODULE_2__.Log.publicError(log)}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function Delay(duration){return new Promise(resolve=>setTimeout(resolve,duration))}function Timeout(duration){return Delay(duration).then(()=>Promise.reject("Timeout after "+duration+"ms"))}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Delay:()=>Delay,Timeout:()=>Timeout})},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{EventTrackerService:()=>EventTrackerService});var _base__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);class EventTrackerService extends _base__WEBPACK_IMPORTED_MODULE_0__.default{constructor(events){super(),this.events=events}getQuery(){return{payload:this.events}}getURLShortname(){return"ev"}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>BaseWebservice});var _config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_parameters_keys_profile__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(18),_parameters_keys_system__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(19);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}const DefaultHeaderKeys=[_parameters_keys_profile__WEBPACK_IMPORTED_MODULE_1__.ProfileKeys.CustomIdentifier,_parameters_keys_profile__WEBPACK_IMPORTED_MODULE_1__.ProfileKeys.UserRegion,_parameters_keys_profile__WEBPACK_IMPORTED_MODULE_1__.ProfileKeys.UserLanguage,_parameters_keys_profile__WEBPACK_IMPORTED_MODULE_1__.ProfileKeys.UserProfileVersion,_parameters_keys_profile__WEBPACK_IMPORTED_MODULE_1__.ProfileKeys.InstallationID,_parameters_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.SDKAPILevel,_parameters_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceTimezone,_parameters_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceTimezoneOffset,_parameters_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceDate,_parameters_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceLanguage],BaseURL="".concat(_config__WEBPACK_IMPORTED_MODULE_0__.WS_URL,"/").concat(_config__WEBPACK_IMPORTED_MODULE_0__.SDK_VERSION,"/");class BaseWebservice{getHeaders(parameterStore){return parameterStore.getParametersValues(DefaultHeaderKeys).then(parameters=>(Object.keys(parameters).forEach(key=>{const value=parameters[key];null!=value&&(parameters[key]=""+value)}),parameters))}getBody(parameterStore){return this.getHeaders(parameterStore).then(h=>_objectSpread(_objectSpread({},this.getQuery()),{},{ids:h}))}getBaseURL(){return BaseURL+this.getURLShortname()}getQuery(){throw new Error("BaseWebservice subclasses should override getQuery()")}getURLShortname(){throw new Error("BaseWebservice subclasses should override getURLShortname()")}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{let ProfileKeys;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ProfileKeys:()=>ProfileKeys}),function(ProfileKeys){ProfileKeys.InstallationID="di",ProfileKeys.CustomIdentifier="cus",ProfileKeys.UserRegion="ure",ProfileKeys.UserLanguage="ula",ProfileKeys.UserProfileVersion="upv",ProfileKeys.Subscription="subscription",ProfileKeys.Subscribed="subscribed",ProfileKeys.LastConfiguration="lastconfig",ProfileKeys.Probation="outOfProbation",ProfileKeys.LegacyProbation="probation"}(ProfileKeys||(ProfileKeys={}))},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{let SystemKeys;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SystemKeys:()=>SystemKeys}),function(SystemKeys){SystemKeys.SDKAPILevel="lvl",SystemKeys.DeviceTimezone="dtz",SystemKeys.DeviceTimezoneOffset="dtzo",SystemKeys.DeviceDate="da",SystemKeys.DeviceLanguage="dla"}(SystemKeys||(SystemKeys={}))},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>HttpError});class HttpError extends Error{constructor(response,message){super(message||'Response not ok. Status text: "'.concat(response.statusText,'"')),this.response=response}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{PublicEvent:()=>PublicEvent});var com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(22),com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(23),_helpers_uuid__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(12);class PublicEvent{constructor(name,isUserInProbation,eventData){if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(name)||!com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventNameRegex.test(name))throw new Error("\n        Invalid event name. Please make sure that the name is made of letters, \n      underscores and numbers only (a-zA-Z0-9_). It also can't be longer than 30 characters. Ignoring event \n        ".concat(name,"."));if(this.id=(0,_helpers_uuid__WEBPACK_IMPORTED_MODULE_2__.default)(),this.name="E.".concat(name.toUpperCase()),this.date=new Date,null!=eventData&&"object"!=typeof eventData)throw new Error("Error while constructing Event: 'eventData' is optional but must be an object if provided");this.data=eventData,this.isInProbation=isUserInProbation}getSerializedParams(){var _this$data,_this$data2,_this$data3;return{label:null===(_this$data=this.data)||void 0===_this$data?void 0:_this$data.label,replay:!1,installInProbation:this.isInProbation,attributes:null===(_this$data2=this.data)||void 0===_this$data2?void 0:_this$data2.attributes,tags:null===(_this$data3=this.data)||void 0===_this$data3?void 0:_this$data3.tags}}toJSON(){return{id:this.id,name:this.name,date:this.date.toISOString(),params:this.getSerializedParams()}}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Consts:()=>Consts});const Consts={AttributeKeyRegexp:/^[a-zA-Z0-9_]{1,30}$/,AttributeStringMaxLength:64,AttributeURLMaxLength:2048,EventDataLabelMaxLength:200,EventDataStringMaxLength:64,EventNameRegex:/^[a-zA-Z0-9_]{1,30}$/,MaxEventAttributesCount:20,MaxEventTagsCount:10,MaxUserAttributesCount:50,MaxUserTagCollectionsCount:15,MaxUserTagPerCollectionCount:50}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function asBoolean(value,fallback){return"boolean"==typeof value?value:"number"==typeof value?0!==value:fallback}function isString(value){return"string"==typeof value||value instanceof String}function isFloat(value){return Number(value)===value&&value%1!=0}function isBoolean(value){return value instanceof Boolean||"boolean"==typeof value}function isNumber(value){return value instanceof Number||"number"==typeof value&&!isNaN(value)}function isDate(value){return value instanceof Date}function isURL(value){return value instanceof URL}function isUnknownObject(value){return value instanceof Object&&!Array.isArray(value)&&null!==value}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{asBoolean:()=>asBoolean,isString:()=>isString,isFloat:()=>isFloat,isBoolean:()=>isBoolean,isNumber:()=>isNumber,isDate:()=>isDate,isURL:()=>isURL,isUnknownObject:()=>isUnknownObject})},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Evt:()=>Evt,EventBus:()=>EventBus,LocalEventBus:()=>LocalEventBus});var _helpers_bounded_queue__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(25),_helpers_deep_obj_compare__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(26),_local_sdk_events__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(27),_logger__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(4);class Evt{constructor(code,detail,consumed){this.code=code,this.detail=detail,this.consumed=consumed}}class EventBus{constructor(){this.listeners=new Map,this.passedEvents=new Map}subscribe(evt,listener){if("function"!=typeof listener||"string"!=typeof evt)throw new Error("wrong parameters");this.getListenersFor(evt).push(listener),_logger__WEBPACK_IMPORTED_MODULE_3__.Log.grouped(_logger__WEBPACK_IMPORTED_MODULE_3__.LogLevel.Info,"local-bus","new listener subscribed",["to: "+evt,listener]),this.emitMissedEvents(evt,listener)}emit(code,detail,consumePrevious){if(code===_local_sdk_events__WEBPACK_IMPORTED_MODULE_2__.default.All)return void _logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("local-bus","The event * can't be triggered");const evt=new Evt(code,detail||{},consumePrevious),passed=this.getPassedEventsFor(code),last=passed.peek();consumePrevious&&(passed.clear(),passed.push(evt)),(0,_helpers_deep_obj_compare__WEBPACK_IMPORTED_MODULE_1__.default)(last,evt)?_logger__WEBPACK_IMPORTED_MODULE_3__.Log.debug("local-bus","skipped",evt):(consumePrevious||passed.push(evt),_logger__WEBPACK_IMPORTED_MODULE_3__.Log.debug("local-bus","emit",evt),(this.listeners.get(code)||[]).forEach(e=>e(evt.detail,evt)),(this.listeners.get(_local_sdk_events__WEBPACK_IMPORTED_MODULE_2__.default.All)||[]).forEach(e=>e(evt.detail,evt)))}getListenersFor(evt){let listeners=this.listeners.get(evt);return listeners||(listeners=[],this.listeners.set(evt,listeners)),listeners}emitMissedEvents(code,listener){code===_local_sdk_events__WEBPACK_IMPORTED_MODULE_2__.default.All?this.passedEvents.forEach((_value,key)=>this.emitMissedEvents(key,listener)):this.passedEvents.has(code)&&this.getPassedEventsFor(code).forEach(evt=>listener(evt.detail,evt))}getPassedEventsFor(code){let events=this.passedEvents.get(code);return null==events&&(events=new _helpers_bounded_queue__WEBPACK_IMPORTED_MODULE_0__.default(10),this.passedEvents.set(code,events)),events}_resetForTests(){this.listeners.clear(),this.passedEvents.clear()}}const LocalEventBus=new EventBus},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>BoundedQueue});class BoundedQueue{constructor(capacity){if(this.backingArray=[],this.capacity=capacity,capacity<=0)throw new Error("Capacity must be greater than zero")}enforceCapacity(){for(;this.backingArray.length>this.capacity;)this.backingArray.shift()}push(value){this.backingArray.push(value),this.enforceCapacity()}peek(){return 0===this.backingArray.length?null:this.backingArray[this.backingArray.length-1]}pop(){return 0===this.backingArray.length?null:this.backingArray.pop()}clear(){this.backingArray.length=0}forEach(method,_thisArg){this.backingArray.forEach(method)}values(){return this.backingArray}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});const isNull=value=>null==value,isBuffer=value=>!(!value||"object"!=typeof value||"number"!=typeof value.length)&&("function"==typeof value.copy&&"function"==typeof value.slice&&!(value.length>0&&"number"!=typeof value[0])),deepEqual=(actual,expected)=>{if(actual===expected)return!0;if(actual instanceof Date&&expected instanceof Date)return actual.getTime()===expected.getTime();if(!actual||!expected||"object"!=typeof actual&&"object"!=typeof expected)return actual===expected;if(isNull(actual)||isNull(expected))return!1;if(actual.prototype!==expected.prototype)return!1;if(isBuffer(actual)){if(!isBuffer(expected)||actual.length!==expected.length)return!1;for(let i=0;i<actual.length;i++)if(actual[i]!==expected[i])return!1;return!0}if(typeof actual!=typeof expected)return!1;let ka,kb;try{ka=Object.keys(actual),kb=Object.keys(expected)}catch(e){return!1}if(ka.length!==kb.length)return!1;for(let i=ka.length-1;i>=0;i--)if(ka[i]!==kb[i])return!1;for(let i=ka.length-1;i>=0;i--){const key=ka[i];if(!deepEqual(actual[key],expected[key]))return!1}return!0},__WEBPACK_DEFAULT_EXPORT__=deepEqual},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{var LocalSDKEvent;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__}),function(LocalSDKEvent){LocalSDKEvent.All="*",LocalSDKEvent.SessionStarted="sessionStarted",LocalSDKEvent.ProfileChanged="profileChanged",LocalSDKEvent.SubscriptionChanged="subscriptionChanged",LocalSDKEvent.UiComponentReady="uiComponentReady",LocalSDKEvent.UiComponentDrawn="uiComponentDrawn",LocalSDKEvent.UiReady="uiReady",LocalSDKEvent.HashChanged="hashChanged",LocalSDKEvent.ExitedProbation="exitedProbation",LocalSDKEvent.DataChanged="dataChanged"}(LocalSDKEvent||(LocalSDKEvent={}));const __WEBPACK_DEFAULT_EXPORT__=LocalSDKEvent},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ProbationManager:()=>ProbationManager});var com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(24),com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(27),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(4),com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(29);class ProbationManager{constructor(parameterStore){this.parameterStore=parameterStore,this.init(),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_0__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_1__.default.SubscriptionChanged,this.onSubscriptionChanged.bind(this))}async isOutOfProbation(){if(this.isOutOfProbationCache)return!0;const probation=await this.parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__.keysByProvider.profile.Probation);return this.isOutOfProbationCache=Boolean(probation),this.isOutOfProbationCache}async isInProbation(){return this.isOutOfProbation().then(out=>!out)}async onSubscriptionChanged(state){const currentIsOutOfProbation=await this.isOutOfProbation();state.subscribed&&!currentIsOutOfProbation&&(this.takeOutOfProbation(),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_0__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_1__.default.ExitedProbation,null,!0),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_2__.Log.debug("probation-manager","exited probation"))}async init(){if(null!==await this.parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__.keysByProvider.profile.Subscription))return void this.takeOutOfProbation();!0===await this.parameterStore.getParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__.keysByProvider.profile.LegacyProbation)&&(this.takeOutOfProbation(),this.parameterStore.removeParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__.keysByProvider.profile.LegacyProbation))}async takeOutOfProbation(){await this.parameterStore.setParameterValue(com_batch_shared_parameters_keys__WEBPACK_IMPORTED_MODULE_3__.keysByProvider.profile.Probation,!0),this.isOutOfProbationCache=!0}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{allowedKeyByProvider:()=>allowedKeyByProvider,keysByProvider:()=>keysByProvider});var _keys_profile__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18),_keys_session__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(30),_keys_system__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(19);function getValuesArrayForStringEnum(e){return Object.keys(e).map(key=>e[key])}const allowedKeyByProvider={profile:getValuesArrayForStringEnum(_keys_profile__WEBPACK_IMPORTED_MODULE_0__.ProfileKeys),session:getValuesArrayForStringEnum(_keys_session__WEBPACK_IMPORTED_MODULE_1__.SessionKeys),system:getValuesArrayForStringEnum(_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys)},keysByProvider={profile:_keys_profile__WEBPACK_IMPORTED_MODULE_0__.ProfileKeys,session:_keys_session__WEBPACK_IMPORTED_MODULE_1__.SessionKeys,system:_keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{let SessionKeys;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{SessionKeys:()=>SessionKeys}),function(SessionKeys){SessionKeys.SessionID="sessionId",SessionKeys.Events="events"}(SessionKeys||(SessionKeys={}))},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>ParameterStore});var com_batch_shared_persistence_profile__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(32),_helpers_deep_obj_compare__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(26),_persistence_session__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(34),_keys__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(29),_profile_parameter_provider__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(35),_session_parameter_provider__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(37),_system_parameter_provider__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(38);let storeInstance=null;class ParameterStore{constructor(p){this.providers=p}getParameterValue(key){return-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.system.indexOf(key)?this.providers.system.getParameterForKey(key):-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.profile.indexOf(key)?this.providers.profile.getParameterForKey(key):-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.session.indexOf(key)?this.providers.session.getParameterForKey(key):Promise.reject("Cannot read ".concat(key,": it is not a managed key"))}async setParameterValue(key,value){return void 0===value||null==value?Promise.reject("Refusing to write null/unknown for ".concat(key,". Use removeParameterValue to do so explicitly.")):-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.profile.indexOf(key)?this.providers.profile.setParameterForKey(key,value):-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.session.indexOf(key)?(await this.providers.session.setParameterForKey(key,String(value)),value):Promise.reject("Cannot set ".concat(key,": it is not a managed key"))}removeParameterValue(key){return-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.profile.indexOf(key)?this.providers.profile.removeParameterForKey(key):-1!==_keys__WEBPACK_IMPORTED_MODULE_3__.allowedKeyByProvider.session.indexOf(key)?this.providers.session.removeParameterForKey(key):Promise.reject("Cannot delete ".concat(key,": it is not a managed key"))}setOrRemoveParameterValueIfChanged(key,value){const definedValue=void 0===value?null:value;return new Promise((resolve,reject)=>{this.getParameterValue(key).then(oldValue=>{(0,_helpers_deep_obj_compare__WEBPACK_IMPORTED_MODULE_1__.default)(oldValue,value)?resolve(!1):null==definedValue?this.removeParameterValue(key).then(()=>resolve(!0)).catch(reject):this.setParameterValue(key,value).then(()=>resolve(!0)).catch(reject)},error=>{reject(error)})})}async getParametersValues(keys){const promises=keys.map(key=>this.getParameterValue(key));return(await Promise.all(promises)).reduce((acc,cur,indice)=>(acc[keys[indice]]=cur,acc),{})}static getInstance(){return new Promise(resolve=>{storeInstance instanceof ParameterStore?resolve(storeInstance):com_batch_shared_persistence_profile__WEBPACK_IMPORTED_MODULE_0__.ProfilePersistence.getInstance().then(db=>{storeInstance=new ParameterStore({profile:new _profile_parameter_provider__WEBPACK_IMPORTED_MODULE_4__.default(db),session:new _session_parameter_provider__WEBPACK_IMPORTED_MODULE_5__.default(new _persistence_session__WEBPACK_IMPORTED_MODULE_2__.default),system:new _system_parameter_provider__WEBPACK_IMPORTED_MODULE_6__.default}),resolve(storeInstance)})})}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ProfilePersistence:()=>ProfilePersistence});var _indexed_db__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(33);class ProfilePersistence extends _indexed_db__WEBPACK_IMPORTED_MODULE_0__.IndexedDbPersistence{getTargetTable(){return _indexed_db__WEBPACK_IMPORTED_MODULE_0__.IndexedDBTable.ProfileData}static getInstance(){return new Promise(resolve=>{resolve(new ProfilePersistence)})}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{IndexedDBTable:()=>IndexedDBTable,IndexedDbPersistence:()=>IndexedDbPersistence});let IndexedDBTable;!function(IndexedDBTable){IndexedDBTable.ProfileData="BatchKVData",IndexedDBTable.UserData="BatchKVCustomData"}(IndexedDBTable||(IndexedDBTable={}));class IndexedDbPersistence{openDatabase(){return new Promise((resolve,reject)=>{indexedDB||reject(new Error("IndexedDB is not available"));const request=indexedDB.open("BatchWebPush",2);request.onerror=err=>{reject(err)},request.onsuccess=event=>{const db=event.target.result;db.onversionchange=()=>{db.close()},this.selfHeal(db),resolve(db)},request.onupgradeneeded=event=>{const db=event.target.result;this.createObjectStore(db)},request.onblocked=()=>{reject(new Error("IndexedDB is blocked by another tab"))}})}createObjectStore(db){db.objectStoreNames.contains(IndexedDBTable.ProfileData)||db.createObjectStore(IndexedDBTable.ProfileData,{keyPath:"k"}),db.objectStoreNames.contains(IndexedDBTable.UserData)||db.createObjectStore(IndexedDBTable.UserData,{keyPath:"k"})}selfHeal(db){db.objectStoreNames.contains(IndexedDBTable.ProfileData)&&db.objectStoreNames.contains(IndexedDBTable.UserData)||this.createObjectStore(db)}async getData(key){const tableName=this.getTargetTable(),db=await this.openDatabase();return new Promise((resolve,reject)=>{const query=db.transaction([tableName]).objectStore(tableName).get(key);query.onerror=reject,query.onsuccess=()=>{const data=query.result;resolve(void 0===data?null:data.value)}}).finally(()=>db.close())}async setData(key,value){const tableName=this.getTargetTable(),db=await this.openDatabase();return new Promise((resolve,reject)=>{const query=db.transaction([tableName],"readwrite").objectStore(tableName).put({k:key,value:value});query.onerror=reject,query.onsuccess=()=>resolve(value)}).finally(()=>db.close())}async removeData(key){const tableName=this.getTargetTable(),db=await this.openDatabase();return new Promise((resolve,reject)=>{const query=db.transaction([tableName],"readwrite").objectStore(tableName).delete(key);query.onerror=reject,query.onsuccess=()=>resolve()}).finally(()=>db.close())}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});const safeWindow=(0,__webpack_require__(5).default)();const __WEBPACK_DEFAULT_EXPORT__=class{getData(key){return null==safeWindow?Promise.reject("No session storage available"):new Promise(resolve=>resolve(safeWindow.sessionStorage.getItem(key)))}setData(key,value){return null==safeWindow?Promise.reject("No session storage available"):new Promise(resolve=>{safeWindow.sessionStorage.setItem(key,value),resolve(value)})}removeData(key){return null==safeWindow?Promise.reject("No session storage available"):new Promise(resolve=>{safeWindow.sessionStorage.removeItem(key),resolve()})}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});var _batch_error__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(36),_keys__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(29);const __WEBPACK_DEFAULT_EXPORT__=class{constructor(storageProvider){this.storage=storageProvider}async getParameterForKey(key){if(-1!==_keys__WEBPACK_IMPORTED_MODULE_1__.allowedKeyByProvider.profile.indexOf(key)){const value=await this.storage.getData(key);return void 0===value?null:value}throw new _batch_error__WEBPACK_IMPORTED_MODULE_0__.default("Cannot read ".concat(key,": it is not a managed profile key"))}setParameterForKey(key,value){return-1!==_keys__WEBPACK_IMPORTED_MODULE_1__.allowedKeyByProvider.profile.indexOf(key)?this.storage.setData(key,value):Promise.reject(new _batch_error__WEBPACK_IMPORTED_MODULE_0__.default("Cannot set ".concat(key,": it is not a managed profile key")))}removeParameterForKey(key){return-1!==_keys__WEBPACK_IMPORTED_MODULE_1__.allowedKeyByProvider.profile.indexOf(key)?this.storage.removeData(key):Promise.reject(new _batch_error__WEBPACK_IMPORTED_MODULE_0__.default("".concat(key," is not a managed profile key")))}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>BatchError});class BatchError extends Error{}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});var _batch_error__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(36),_keys__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(29);const __WEBPACK_DEFAULT_EXPORT__=class{constructor(storageProvider){this.storage=storageProvider}async getParameterForKey(key){if(-1!==_keys__WEBPACK_IMPORTED_MODULE_1__.allowedKeyByProvider.session.indexOf(key)){const value=await this.storage.getData("com.batch."+key);return void 0===value?null:value}throw new _batch_error__WEBPACK_IMPORTED_MODULE_0__.default("Cannot read ".concat(key,": it is not a managed session key"))}setParameterForKey(key,value){return-1!==_keys__WEBPACK_IMPORTED_MODULE_1__.allowedKeyByProvider.session.indexOf(key)?this.storage.setData("com.batch."+key,value):Promise.reject(new _batch_error__WEBPACK_IMPORTED_MODULE_0__.default("Cannot set ".concat(key,": it is not a managed session key")))}removeParameterForKey(key){return-1!==_keys__WEBPACK_IMPORTED_MODULE_1__.allowedKeyByProvider.session.indexOf(key)?(this.storage.removeData("com.batch."+key),Promise.resolve()):Promise.reject(new _batch_error__WEBPACK_IMPORTED_MODULE_0__.default("Cannot delete ".concat(key,": it is not a managed session key")))}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});var _config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_batch_error__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(36),_keys_system__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(19);class SystemParameterProvider{getParameterForKey(key){return new Promise(resolve=>{switch(key){case _keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.SDKAPILevel:resolve(_config__WEBPACK_IMPORTED_MODULE_0__.SDK_API_LVL);break;case _keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceTimezone:resolve(SystemParameterProvider.getTimezone()||"");break;case _keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceTimezoneOffset:resolve((new Date).getTimezoneOffset().toString());break;case _keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceLanguage:{const navigator=self.navigator;resolve(null!=navigator?navigator.language:"")}break;case _keys_system__WEBPACK_IMPORTED_MODULE_2__.SystemKeys.DeviceDate:resolve((new Date).toISOString());break;default:throw new _batch_error__WEBPACK_IMPORTED_MODULE_1__.default("".concat(key," is not a managed system key"))}})}static getTimezone(){if(self.Intl){const autoTZ=self.Intl.DateTimeFormat().resolvedOptions().timeZone;if(autoTZ)return autoTZ}return null}}const __WEBPACK_DEFAULT_EXPORT__=SystemParameterProvider},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{UserDataPersistence:()=>UserDataPersistence});var _indexed_db__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(33);class UserDataPersistence extends _indexed_db__WEBPACK_IMPORTED_MODULE_0__.IndexedDbPersistence{getTargetTable(){return _indexed_db__WEBPACK_IMPORTED_MODULE_0__.IndexedDBTable.UserData}static getInstance(){return new Promise(resolve=>{resolve(new UserDataPersistence)})}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{TypedEventAttributeType:()=>TypedEventAttributeType,EventData:()=>EventData});var com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(22),com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(23),com_batch_shared_helpers_typed_attribute__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(41),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(4);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}let TypedEventAttributeType;!function(TypedEventAttributeType){TypedEventAttributeType.STRING="s",TypedEventAttributeType.BOOLEAN="b",TypedEventAttributeType.INTEGER="i",TypedEventAttributeType.FLOAT="f",TypedEventAttributeType.DATE="t",TypedEventAttributeType.URL="u"}(TypedEventAttributeType||(TypedEventAttributeType={}));class EventData{constructor(params){const label=EventData.getLabel(null==params?void 0:params.label);label&&(this.label=label),this.tags=EventData.getTags(params),this.attributes=EventData.getAttributes(params)}static getTags(params){const tags=new Set;return params&&params.tags&&params.tags.forEach((tag,index)=>{index>=com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxEventTagsCount?com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Tags can't be longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxEventTagsCount," elements. Ignoring tag ").concat(tag)):void 0!==tag?(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(tag)?0===tag.length||tag.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataStringMaxLength?com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Tags can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataStringMaxLength," characters. Ignoring tag ").concat(tag,".")):tags.add(tag.toLowerCase()):com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Tag argument must be a string. Ignoring tag ".concat(tag,".")):com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","A tag is required.")}),Array.from(tags)}static autoDetectNoTypedAttribute(key,value){const attribute={};if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isURL)(value)){const URLToString=URL.prototype.toString.call(value);return 0===URLToString.length||URLToString.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","URL attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength," characters. Ignoring attribute ").concat(key,".")):(attribute["".concat(key.toLowerCase(),".").concat(TypedEventAttributeType.URL)]=URL.prototype.toString.call(value),attribute)}return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(value)?0===value.length||value.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","String attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength," characters. Ignoring attribute ").concat(key,".")):(attribute["".concat(key.toLowerCase(),".").concat(TypedEventAttributeType.STRING)]=value,attribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isDate)(value)?(attribute["".concat(key.toLowerCase(),".").concat(TypedEventAttributeType.DATE)]=value.getTime(),attribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isFloat)(value)?(attribute["".concat(key.toLowerCase(),".").concat(TypedEventAttributeType.FLOAT)]=value,attribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(value)?(attribute["".concat(key.toLowerCase(),".").concat(TypedEventAttributeType.INTEGER)]=value,attribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isBoolean)(value)?(attribute["".concat(key.toLowerCase(),".").concat(TypedEventAttributeType.BOOLEAN)]=value,attribute):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("No type corresponding to this value ".concat(value,". Ignoring attribute ").concat(key))}static convertValueAttribute(key,v){const{value:value,type:type}=v;switch(type){case TypedEventAttributeType.URL:if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isURL)(value)){const URLToString=URL.prototype.toString.call(value);return 0===URLToString.length||URLToString.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","URL attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength," characters. Ignoring attribute ").concat(key,".")):URLToString}if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(value))try{const convertedUrlValue=new URL(value),URLToString=URL.prototype.toString.call(convertedUrlValue);return 0===URLToString.length||URLToString.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","URL attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength," characters. Ignoring attribute ").concat(key,".")):URLToString}catch(e){return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the URL type, must respect scheme://[authority][path][?query][#fragment] format. Ignoring attribute ".concat(key,"."))}return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the URL type. Must be a string, or URL. Ignoring attribute with this value: ".concat(key,"."));case TypedEventAttributeType.STRING:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(value)?0===value.length||value.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","String attribute value can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength," characters. \n              Ignoring attribute ").concat(key,".")):value:(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(value)?value.toString():void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the STRING type. Must be a string, or number. Ignoring attribute with this value: ".concat(key,"."));case TypedEventAttributeType.INTEGER:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(value)||(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(value)?Math.ceil(Number(value)):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the INTEGER type. Must be a string, or number. Ignoring attribute with this value: ".concat(key,"."));case TypedEventAttributeType.FLOAT:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(value)||(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(value)?Number(value):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the FLOAT type. Must be a string, or number. Ignoring attribute with this value: ".concat(key,"."));case TypedEventAttributeType.BOOLEAN:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(value)||(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isBoolean)(value)?Boolean(value):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the BOOLEAN type. Must be a boolean or number. Ignoring attribute with this value: ".concat(key,"."));case TypedEventAttributeType.DATE:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isDate)(value)?value.getTime():void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid attribute value for the DATE type. Must be a DATE. Ignoring attribute with this value: ".concat(key,"."));default:com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("The type: ".concat(type," not exist. Ignoring attribute ").concat(key,"."))}}static getAttributes(params){let attributes={};if(params&&params.attributes){let index=0;for(const[key,value]of Object.entries(params.attributes)){if(index>=com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxEventAttributesCount)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Cannot have more than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxEventAttributesCount," attributes.")),attributes;if(this.keyAndValueValid(key,value))if((0,com_batch_shared_helpers_typed_attribute__WEBPACK_IMPORTED_MODULE_2__.isTypedAttributeValue)(value)){const attribute={};try{const valueConverted=this.convertValueAttribute(key,value);void 0!==valueConverted&&(attribute["".concat(key.toLowerCase(),".").concat(value.type)]=valueConverted,attributes=_objectSpread(_objectSpread({},attributes),attribute))}catch(e){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.error("Event Data","Error when auto-detecting attributes:",e)}}else try{const attribute=this.autoDetectNoTypedAttribute(key,value);void 0!==attribute&&(attributes=_objectSpread(_objectSpread({},attributes),attribute))}catch(e){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.error("Event Data","Error while converted attributes:",e)}index+=1}}return attributes}static getLabel(label){if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(label)){if(0===label.length||label.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataLabelMaxLength)return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Label can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataLabelMaxLength," characters. Ignoring label ").concat(label,"."))}else if(null!=label&&void 0!==label)return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("If supplied, label argument must be a string. Ignoring label ".concat(label,"."));return label}static keyAndValueValid(key,value){return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(key)?com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeKeyRegexp.test(key||"")?null!=value||(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","value cannot be undefined or null. Ignoring attribute ".concat(key,".")),!1):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","Invalid key. Please make sure that the key is made of letters, \n      underscores and numbers only (a-zA-Z0-9_). It also can't be longer than 30 characters. Ignoring attribute \n        ".concat(key,".")),!1):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("Event Data","key must be a string."),!1)}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{isTypedAttributeValue:()=>isTypedAttributeValue});const isTypedAttributeValue=value=>"object"==typeof value&&!(value instanceof Date)&&!(value instanceof URL)&&Object.prototype.hasOwnProperty.call(value,"type")&&Object.prototype.hasOwnProperty.call(value,"value")},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{UserAttributeType:()=>UserAttributeType,UserDataOperation:()=>UserDataOperation,UserAttributeEditor:()=>UserAttributeEditor});var com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(22),com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(23),com_batch_shared_helpers_typed_attribute__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(41),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(4);function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}const logModuleName="User Attribute Editor";let UserAttributeType,UserDataOperation;!function(UserAttributeType){UserAttributeType.STRING="s",UserAttributeType.BOOLEAN="b",UserAttributeType.INTEGER="i",UserAttributeType.FLOAT="f",UserAttributeType.DATE="t",UserAttributeType.URL="u"}(UserAttributeType||(UserAttributeType={})),function(UserDataOperation){UserDataOperation.SetAttribute="SET_ATTRIBUTE",UserDataOperation.RemoveAttribute="REMOVE_ATTRIBUTE",UserDataOperation.ClearAttributes="CLEAR_ATTRIBUTES",UserDataOperation.AddTag="ADD_TAG",UserDataOperation.RemoveTag="REMOVE_TAG",UserDataOperation.ClearTags="CLEAR_TAGS",UserDataOperation.ClearTagCollection="CLEAR_TAG_COLLECTION"}(UserDataOperation||(UserDataOperation={}));class UserAttributeEditor{constructor(){_defineProperty(this,"_operationQueue",[]),_defineProperty(this,"usable",!0),this.usable||com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"The editor is temporarily unusable while processing all operations."),this._operationQueue=[]}_getOperations(){return this._operationQueue}_markAsUnusable(){this.usable=!1}_enqueueOperation(operation){this._operationQueue.push(operation)}addTag(collection,tag){return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(collection)?com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeKeyRegexp.test(collection||"")?void 0===tag?(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"A tag is required."),this):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(tag)?0===tag.length||tag.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataStringMaxLength?(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Tags can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataStringMaxLength," characters. Ignoring tag ").concat(tag,".")),this):(this._enqueueOperation({operation:UserDataOperation.AddTag,collection:collection.toLowerCase(),tag:tag}),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Tag argument must be a string. Ignoring tag ".concat(tag,".")),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid collection. Please make sure that the collection is made of letters, \n        underscores and numbers only (a-zA-Z0-9_). It also can't be longer than 30 characters. Ignoring collection \n          ".concat(collection,".")),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Collection argument must be a string"),this)}removeTag(collection,tag){return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(collection)?com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeKeyRegexp.test(collection||"")?(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(tag)?0===tag.length||tag.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataStringMaxLength?(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Tags can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.EventDataStringMaxLength," characters. Ignoring tag ").concat(tag,".")),this):(this._enqueueOperation({operation:UserDataOperation.RemoveTag,collection:collection,tag:tag}),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Tag argument must be a string. Ignoring tag ".concat(tag,".")),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid collection. Please make sure that the collection is made of letters, \n        underscores and numbers only (a-zA-Z0-9_). It also can't be longer than 30 characters. Ignoring collection \n          ".concat(collection,".")),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Collection argument must be a string"),this)}clearTagCollection(collection){return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(collection)?com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeKeyRegexp.test(collection||"")?(this._enqueueOperation({operation:UserDataOperation.ClearTagCollection,collection:collection}),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid collection. Please make sure that the collection is made of letters, \n        underscores and numbers only (a-zA-Z0-9_). It also can't be longer than 30 characters. Ignoring collection \n          ".concat(collection,".")),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Collection argument must be a string"),this)}clearTags(){return this._enqueueOperation({operation:UserDataOperation.ClearTags}),this}setAttribute(key,value){if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(key))return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"key must be a string."),this;if(!com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeKeyRegexp.test(key||""))return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid key. Please make sure that the key is made of letters, \n      underscores and numbers only (a-zA-Z0-9_). It also can't be longer than 30 characters. Ignoring attribute \n        ".concat(key,".")),this;const operationData={value:value,key:key,type:""};if((0,com_batch_shared_helpers_typed_attribute__WEBPACK_IMPORTED_MODULE_2__.isTypedAttributeValue)(value)){if(void 0===value.value||null===value.value)return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"value cannot be undefined or null. Ignoring attribute ".concat(key,".")),this;const userAttributeValueConverted=UserAttributeEditor.convertValueUserAttribute(value,key);if(void 0===userAttributeValueConverted)return this;operationData.value=userAttributeValueConverted,operationData.type=value.type}else{const userAttribute=UserAttributeEditor.autoDetectNoTypedUserAttribute(key,value);if(void 0===userAttribute)return this;operationData.type=userAttribute.type,operationData.value=userAttribute.value}return this._enqueueOperation({operation:UserDataOperation.SetAttribute,key:operationData.key.toLowerCase(),type:operationData.type,value:operationData.value}),this}removeAttribute(key){return com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeKeyRegexp.test(key||"")?(this._enqueueOperation({operation:UserDataOperation.RemoveAttribute,key:key}),this):(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid key. Please make sure that the key is made of letters, underscores and numbers only (a-zA-Z0-9_). \n         It also can't be longer than 30 characters. Ignoring attribute \n          ".concat(key,".")),this)}clearAttributes(){return this._enqueueOperation({operation:UserDataOperation.ClearAttributes}),this}static autoDetectNoTypedUserAttribute(key,value){const userAttribute={value:"",type:""};if(null!=value){if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isURL)(value)){const URLToString=URL.prototype.toString.call(value);return 0===URLToString.length||URLToString.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"URL attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength," characters. Ignoring attribute ").concat(key,".")):(userAttribute.value=URL.prototype.toString.call(value),userAttribute.type=UserAttributeType.URL,userAttribute)}return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(value)?0===value.length||value.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"String attributes can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength,"\n          characters. Ignoring attribute ").concat(key,".")):(userAttribute.value=value,userAttribute.type=UserAttributeType.STRING,userAttribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isDate)(value)?(userAttribute.value=value.getTime(),userAttribute.type=UserAttributeType.DATE,userAttribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isFloat)(value)?(userAttribute.value=value,userAttribute.type=UserAttributeType.FLOAT,userAttribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(value)?(userAttribute.value=value,userAttribute.type=UserAttributeType.INTEGER,userAttribute):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isBoolean)(value)?(userAttribute.value=value,userAttribute.type=UserAttributeType.BOOLEAN,userAttribute):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("No type corresponding to this value ".concat(value,". Ignoring attribute ").concat(key,"."))}com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"value cannot be undefined or null. Ignoring attribute ".concat(key,"."))}static convertValueUserAttribute(userAttribute,key){switch(userAttribute.type){case UserAttributeType.URL:if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isURL)(userAttribute.value)){const URLToString=URL.prototype.toString.call(userAttribute.value);return 0===URLToString.length||URLToString.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"URL attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength," characters. Ignoring attribute ").concat(key,".")):URLToString}if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(userAttribute.value))try{const convertedUrlValue=new URL(userAttribute.value),URLToString=URL.prototype.toString.call(convertedUrlValue);return 0===URLToString.length||URLToString.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"URL attribute can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeURLMaxLength," characters. Ignoring attribute ").concat(key,".")):URLToString}catch(e){return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the URL type, must respect scheme://[authority][path][?query][#fragment] format. Ignoring attribute ".concat(key,"."))}return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the URL type. Must be a string, or URL. \n            Ignoring attribute with this value: ".concat(userAttribute.value,"."));case UserAttributeType.STRING:return 0===userAttribute.value.length||userAttribute.value.length>com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength?void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"String attributes can't be empty or longer than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.AttributeStringMaxLength,"\n            characters. Ignoring attribute ").concat(key,".")):(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(userAttribute.value)||(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(userAttribute.value)?userAttribute.value.toString():void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the STRING type. Must be a string, or number. \n          Ignoring attribute with this value: ".concat(userAttribute.value,"."));case UserAttributeType.INTEGER:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(userAttribute.value)||(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(userAttribute.value)?Math.ceil(Number(userAttribute.value)):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the INTEGER type. Must be a string, or number. \n          Ignoring attribute with this value: ".concat(userAttribute.value,"."));case UserAttributeType.FLOAT:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isString)(userAttribute.value)||(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isNumber)(userAttribute.value)?Number(userAttribute.value):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the FLOAT type. Must be a string, or number. \n          Ignoring attribute with this value: ".concat(userAttribute.value,"."));case UserAttributeType.BOOLEAN:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isBoolean)(userAttribute.value)?Boolean(userAttribute.value):void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the BOOLEAN type. Must be a boolean or number. \n          Ignoring attribute with this value: ".concat(userAttribute.value,"."));case UserAttributeType.DATE:return(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_1__.isDate)(userAttribute.value)?userAttribute.value.getTime():void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn(logModuleName,"Invalid attribute value for the DATE type. Must be a DATE. \n          Ignoring attribute with this value: ".concat(userAttribute.value,"."));default:return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("The type: ".concat(userAttribute.type," not exist. Ignoring attribute."))}}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{UserModule:()=>UserModule});var com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23),com_batch_shared_helpers_task_queue__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(44),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(24),com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(27),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(4),com_batch_shared_user_user_data_diff__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(45),com_batch_shared_user_user_data_public__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(47),com_batch_shared_user_user_data_storage__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(48),com_batch_shared_webservice_attributes_check__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(49),com_batch_shared_webservice_attributes_send__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(50),com_batch_shared_webservice_responses_attributes_check_response__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(51),_user_attribute_editor__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(42),_user_data_writer__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(52);class UserModule{constructor(probationManager,persistence,webserviceExecutor){this.probationManager=probationManager,this.persistence=persistence,this.userDataStorage=new com_batch_shared_user_user_data_storage__WEBPACK_IMPORTED_MODULE_7__.UserDataStorage(this.persistence),this.webserviceExecutor=webserviceExecutor,this.taskQueue=new com_batch_shared_helpers_task_queue__WEBPACK_IMPORTED_MODULE_1__.TaskQueue,com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__.default.ExitedProbation,this.onExitedProbation.bind(this)),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__.default.SessionStarted,this.onSessionStarted.bind(this))}async getPublicAttributes(){const privateAttributes=await this.userDataStorage.getAttributes(),publicAttributes={};for(const[key,typedValue]of Object.entries(privateAttributes)){const type=typedValue.type;let value=typedValue.value;type===_user_attribute_editor__WEBPACK_IMPORTED_MODULE_11__.UserAttributeType.DATE&&(value=new Date(value)),publicAttributes[key]=new com_batch_shared_user_user_data_public__WEBPACK_IMPORTED_MODULE_6__.BatchUserAttribute(type,value)}return publicAttributes}async getPublicTagCollections(){return await this.userDataStorage.getTagsAsArrays()}onExitedProbation(){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.debug("User","User is out of probation, sending data."),this.scheduleAttributesSend()}onSessionStarted(){this.scheduleAttributesCheck()}editUserData(editor){const operations=editor._getOperations();this.taskQueue.postAsync(()=>this.applyUserOperations(operations).catch(e=>{com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.warn("User","Failed to edit user data:",e)}))}async applyUserOperations(operations){const oldAttributes=await this.userDataStorage.getAttributes(),oldTags=await this.userDataStorage.getTags(),userDataWriter=new _user_data_writer__WEBPACK_IMPORTED_MODULE_12__.UserDataWriter(oldAttributes,oldTags),{attributes:newAttributes,tags:newTags}=await userDataWriter.applyOperations(operations);if(!(0,com_batch_shared_user_user_data_diff__WEBPACK_IMPORTED_MODULE_5__.hasUserDataChanged)(oldAttributes,oldTags,newAttributes,newTags))return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.debug("User","User saved data but no changes were detected.");await Promise.all([this.userDataStorage.persistAttributes(newAttributes),this.userDataStorage.persistTags(newTags),this.userDataStorage.removeTxid(),this.userDataStorage.removeLastCheckTimestamp()]);if(!await this.probationManager.isOutOfProbation())return await this.userDataStorage.persistVersion(1),void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.debug("User","User is in probation, not sending data.");const newVersion=await this.userDataStorage.getVersion()+1;await this.userDataStorage.persistVersion(newVersion),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__.default.DataChanged,null,!0),this.scheduleAttributesSend()}scheduleAttributesSend(){this.taskQueue.postAsync(()=>this.sendAttributes().catch(e=>{com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.error("User","Could not synchronize user data with the server:",e)}))}async sendAttributes(){const attributes=await this.userDataStorage.getAttributes(),tags=await this.userDataStorage.getTags(),version=await this.userDataStorage.getVersion();if(version<1)return;if(await this.userDataStorage.getTxid())return;const response=await this.webserviceExecutor.start(new com_batch_shared_webservice_attributes_send__WEBPACK_IMPORTED_MODULE_9__.AttributesSendService(attributes,tags,version));if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isUnknownObject)(response))throw new Error("Internal Error: bad server response (code 1)");const responseTrid=response.trid;if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isString)(responseTrid)||0===responseTrid.length)throw new Error("Internal Error: bad server response (code 2)");const responseVersion=response.ver;if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isNumber)(responseVersion))throw new Error("Internal Error: bad server response (code 3)");version===responseVersion?await this.userDataStorage.persistTxid(responseTrid):com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.debug("User","Server replied a txid for the wrong version, ignoring it.")}scheduleAttributesCheck(){this.taskQueue.postAsync(async()=>{const lastCheck=await this.userDataStorage.getLastCheckTimestamp();lastCheck&&lastCheck+3e5>=Date.now()||await this.checkWithServer().catch(e=>{com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.error("User","Could not verify user data with the server:",e)})})}async checkWithServer(){const txid=await this.userDataStorage.getTxid();if(!txid)return;const ver=await this.userDataStorage.getVersion();if(ver<1)return;const response=await this.webserviceExecutor.start(new com_batch_shared_webservice_attributes_check__WEBPACK_IMPORTED_MODULE_8__.AttributesCheckService(txid,ver));if(!(0,com_batch_shared_webservice_responses_attributes_check_response__WEBPACK_IMPORTED_MODULE_10__.isAttributesCheckResponse)(response))throw new Error("Could not parse server response");switch(response.action=response.action.toUpperCase(),response.action){case"OK":return void this.userDataStorage.persistLastCheckTimestamp(Date.now());case"BUMP":{const currentVersion=await this.userDataStorage.getVersion();response.ver>=currentVersion&&this.scheduleBumpVersion(currentVersion,response.ver)}return;case"RESEND":return void this.resendAttributes();case"RECHECK":return}}async resendAttributes(){await this.userDataStorage.removeTxid(),this.scheduleAttributesSend()}scheduleBumpVersion(fromVersion,serverVersion){this.taskQueue.postAsync(()=>this.bumpVersion(fromVersion,serverVersion))}async bumpVersion(fromVersion,serverVersion){await this.userDataStorage.getVersion()===fromVersion?(await this.userDataStorage.persistVersion(serverVersion+1),await this.userDataStorage.removeTxid(),this.scheduleAttributesSend()):com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.debug("User","Version changed since server asked us to bump it, ignoring.")}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{TaskQueue:()=>TaskQueue});class TaskQueue{constructor(){this.queue=[]}postAsync(taskFunction){const taskItem={runnable:taskFunction,resolve:void 0,reject:void 0},result=new Promise((resolve,reject)=>{taskItem.resolve=resolve.bind(void 0),taskItem.reject=reject.bind(void 0)});return this.queue.push(taskItem),this.scheduleNextTask(),result}scheduleNextTask(){setTimeout(()=>{this.executeNextTask()},0)}executeNextTask(){if(this.currentTask)return;const task=this.queue.shift();if(!task)return;let result;this.currentTask=task;try{result=task.runnable()}catch(e){return void this.taskCompleted(task,!1,void 0,e)}result instanceof Promise?result.then(promiseResult=>{this.taskCompleted(task,!0,promiseResult,void 0)}).catch(promiseError=>{this.taskCompleted(task,!1,void 0,promiseError)}):this.taskCompleted(task,!0,result,void 0)}taskCompleted(task,success,result,error){success?task.resolve(result):void 0!==error?task.reject(error):task.reject(new Error("Internal task queue error")),this.currentTask===task&&(this.currentTask=void 0),this.queue.length>0&&this.scheduleNextTask()}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{hasUserDataChanged:()=>hasUserDataChanged});var com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(46);function diffTagCollection(oldTags,newTags){const result={added:new Set,removed:new Set};if(0===newTags.size)return 0===oldTags.size||(result.removed=oldTags),result;if(0===oldTags.size)return result.added=newTags,result;const removedTags=new Set(oldTags),addedTags=new Set;return newTags.forEach(newTag=>{removedTags.delete(newTag)||addedTags.add(newTag)}),result.added=addedTags,result.removed=removedTags,result}function hasUserDataChanged(oldAttributes,oldTags,newAttributes,newTags){const attributesDiff=function(oldAttributes,newAttributes){const result={added:{},removed:(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_0__.default)(oldAttributes)};for(const[name,newAttributeValue]of Object.entries(newAttributes)){const oldAttributeValue=oldAttributes[name];(first=oldAttributeValue)===(second=newAttributeValue)||void 0!==first&&void 0!==second&&first.type===second.type&&first.value===second.value?delete result.removed[name]:result.added[name]=Object.assign({},newAttributeValue)}var first,second;return result}(oldAttributes,newAttributes),tagsDiff=function(oldTags,newTags){const result={added:{},removed:(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_0__.default)(oldTags)};for(const[name,newTagCollection]of Object.entries(newTags)){var _result$removed$name;const collectionDiff=diffTagCollection(null!==(_result$removed$name=result.removed[name])&&void 0!==_result$removed$name?_result$removed$name:[],newTagCollection);collectionDiff.added.size>0&&(result.added[name]=collectionDiff.added),collectionDiff.removed.size>0?result.removed[name]=collectionDiff.removed:delete result.removed[name]}return result}(oldTags,newTags);return Object.keys(attributesDiff.added).length>0||Object.keys(attributesDiff.removed).length>0||Object.keys(tagsDiff.added).length>0||Object.keys(tagsDiff.removed).length>0}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function deepClone(src){const source=src;if("object"!=typeof source)return source;if(null==source)return null;if(source instanceof Date)return new Date(source);if(source instanceof Array){const outArray=[];for(let i=0;i<source.length;i++)outArray[i]=deepClone(source[i]);return outArray}if(source instanceof Set){const outSet=new Set;return source.forEach(elem=>{outSet.add(deepClone(elem))}),outSet}if(source instanceof Object){const outObject={};for(const prop in source)Object.prototype.hasOwnProperty.call(source,prop)&&(outObject[prop]=deepClone(source[prop]));return outObject}return source}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>deepClone})},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{BatchUserAttribute:()=>BatchUserAttribute});var _user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(42);class BatchUserAttribute{constructor(_type,_value){this._type=_type,this._value=_value}getType(){return this._type}getValue(){return this._value instanceof Date?new Date(this._value.getTime()):this._value}getStringValue(){if(this._type==_user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__.UserAttributeType.STRING)return this._value}getBooleanValue(){if(this._type==_user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__.UserAttributeType.BOOLEAN)return this._value}getNumberValue(){if(this._type==_user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__.UserAttributeType.INTEGER||this._type==_user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__.UserAttributeType.FLOAT)return this._value}getDateValue(){if(this._type==_user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__.UserAttributeType.DATE)return new Date(this._value.getTime())}getURLValue(){if(this._type==_user_attribute_editor__WEBPACK_IMPORTED_MODULE_0__.UserAttributeType.URL)return new URL(URL.prototype.toString.call(this._value))}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{UserDataStorage:()=>UserDataStorage});var Keys,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23);!function(Keys){Keys.UserAttributes="attributes",Keys.UserTagCollections="tags",Keys.Version="ver",Keys.Txid="txid",Keys.LastCheckTimestamp="last_atc"}(Keys||(Keys={}));class UserDataStorage{constructor(persistence){this.persistence=persistence}async persistAttributes(attributes){await this.persistence.setData(Keys.UserAttributes,attributes)}async persistTags(tagCollections){const outTagArrays={};for(const[collection,tagSet]of Object.entries(tagCollections))outTagArrays[collection]=Array.from(tagSet);await this.persistence.setData(Keys.UserTagCollections,outTagArrays)}async persistTxid(txid){await this.persistence.setData(Keys.Txid,txid)}async persistVersion(version){await this.persistence.setData(Keys.Version,version)}async persistLastCheckTimestamp(timestamp){await this.persistence.setData(Keys.LastCheckTimestamp,timestamp)}async removeTxid(){await this.persistence.removeData(Keys.Txid)}async removeLastCheckTimestamp(){await this.persistence.removeData(Keys.LastCheckTimestamp)}async getAttributes(){const attributes=await this.persistence.getData(Keys.UserAttributes);return null===attributes?{}:attributes}async getVersion(){const version=await this.persistence.getData(Keys.Version);return null===version?0:version}async getTagsAsArrays(){const tags=await this.persistence.getData(Keys.UserTagCollections);return null===tags?{}:tags}async getTags(){const tagCollections=await this.getTagsAsArrays(),outTagSets={};for(const[collection,tags]of Object.entries(tagCollections))outTagSets[collection]=new Set(tags);return outTagSets}async getTxid(){const txid=await this.persistence.getData(Keys.Txid);if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isString)(txid))return txid}async getLastCheckTimestamp(){const timestamp=await this.persistence.getData(Keys.LastCheckTimestamp);if((0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isNumber)(timestamp))return timestamp}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AttributesCheckService:()=>AttributesCheckService});var _base__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);class AttributesCheckService extends _base__WEBPACK_IMPORTED_MODULE_0__.default{constructor(transactionID,ver){super(),this.transactionID=transactionID,this.ver=ver}getPayload(){return{trid:this.transactionID,ver:this.ver}}getQuery(){return{payload:this.getPayload()}}getURLShortname(){return"atc"}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AttributesSendService:()=>AttributesSendService});var _base__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);class AttributesSendService extends _base__WEBPACK_IMPORTED_MODULE_0__.default{constructor(attributes,tags,ver){super(),this.attributes=attributes,this.tags=tags,this.ver=ver}getPayload(){const payload={tags:{},attrs:{},ver:this.ver};return payload.attrs=this.convertAttributes(this.attributes),payload.tags=this.convertTags(this.tags),payload.ver=this.ver,payload}getQuery(){return{payload:this.getPayload()}}getURLShortname(){return"ats"}convertAttributes(attributes){const attrs={};for(const[key,value]of Object.entries(attributes))attrs["".concat(key.toLowerCase(),".").concat(value.type)]=value.value;return attrs}convertTags(tagCollections){const outTagArrays={};for(const[collection,tagSet]of Object.entries(tagCollections))outTagArrays[collection]=Array.from(tagSet);return outTagArrays}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{isAttributesCheckResponse:()=>isAttributesCheckResponse});var com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23);function isAttributesCheckResponse(response){if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isUnknownObject)(response))return!1;if(!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isString)(response.action))return!1;const action=response.action.toUpperCase();return("OK"===action||"BUMP"===action||"RESEND"===action||"RECHECK"===action)&&!("BUMP"===action&&!(0,com_batch_shared_helpers_primitive__WEBPACK_IMPORTED_MODULE_0__.isNumber)(response.ver))}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{UserDataWriter:()=>UserDataWriter});var com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(22),com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(46),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(4),_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(42);function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}class UserDataWriter{constructor(currentAttributes,currentTags){_defineProperty(this,"attributes",{}),_defineProperty(this,"tags",{}),this.attributes=(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_1__.default)(currentAttributes),this.tags=(0,com_batch_shared_helpers_object_deep_clone__WEBPACK_IMPORTED_MODULE_1__.default)(currentTags)}checkLimitsTags(tags){if(Object.keys(tags).length>=com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxUserTagCollectionsCount)throw new Error("Custom data cannot hold more than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxUserTagCollectionsCount," tag collections. Rolling back transaction."));for(const element in tags)if(tags[element].size>=com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxUserTagPerCollectionCount)throw new Error("A tag collection cannot hold more than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxUserTagPerCollectionCount," tags. Rolling back transaction."))}applyTags(operationsTags){for(const tagOperation of operationsTags)switch(tagOperation.operation){case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.AddTag:{var _this$tags$tagCollect;const tagCollection=this.normalizeTagOrCollection(tagOperation.collection),tag=this.normalizeTagOrCollection(tagOperation.tag),targetSet=null!==(_this$tags$tagCollect=this.tags[tagCollection])&&void 0!==_this$tags$tagCollect?_this$tags$tagCollect:new Set;targetSet.add(tag),this.tags[tagCollection]=targetSet}break;case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.RemoveTag:{const tagCollection=this.normalizeTagOrCollection(tagOperation.collection),targetSet=this.tags[tagCollection];null==targetSet||targetSet.delete(this.normalizeTagOrCollection(tagOperation.tag)),0===targetSet.size&&delete this.tags[tagCollection]}break;case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.ClearTagCollection:delete this.tags[this.normalizeTagOrCollection(tagOperation.collection)];break;case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.ClearTags:this.tags={};break;default:com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_2__.Log.warn("User attribute","Internal error. The operation: ".concat(tagOperation.operation," does not exist. Ignoring tag."))}return this.checkLimitsTags(this.tags),this.tags}applyAttributes(operationsAttributes){for(const operationAttributes of operationsAttributes)switch(operationAttributes.operation){case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.SetAttribute:this.attributes[this.normalizeAttributeName(operationAttributes.key)]={value:operationAttributes.value,type:operationAttributes.type};break;case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.ClearAttributes:this.attributes={};break;case _user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.RemoveAttribute:delete this.attributes[this.normalizeAttributeName(operationAttributes.key)]}if(Object.keys(this.attributes).length>=com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxUserAttributesCount)throw new Error("Custom data cannot hold more than ".concat(com_batch_shared_constants_user__WEBPACK_IMPORTED_MODULE_0__.Consts.MaxUserAttributesCount," attributes. Rolling back transaction."));return this.attributes}normalizeTagOrCollection(tagOrCollection){return tagOrCollection.toLowerCase()}normalizeAttributeName(attributeName){return attributeName.toLowerCase()}async applyOperations(operations){const operationsTags=operations.filter(operation=>[_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.AddTag,_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.ClearTagCollection,_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.ClearTags,_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.RemoveTag].includes(operation.operation)),operationsAttributes=operations.filter(operation=>[_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.SetAttribute,_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.ClearAttributes,_user_attribute_editor__WEBPACK_IMPORTED_MODULE_3__.UserDataOperation.RemoveAttribute].includes(operation.operation));return{tags:this.applyTags(operationsTags),attributes:this.applyAttributes(operationsAttributes)}}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>WebserviceExecutor});var _logger__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4),_http_error__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(20);class WebserviceExecutor{constructor(apiKey,authKey,devMode,referrer,parameterStore){this.apiKey=apiKey,this.authKey=authKey,this.devMode=devMode,this.referrer=referrer,this.parameterStore=parameterStore}async start(ws){if("undefined"==typeof fetch)return Promise.reject(new Error("fetch API isn't available"));const options={body:"",cache:"no-cache",credentials:"omit",headers:new Headers({Accept:"application/json","Content-Type":"application/json"}),method:"POST",mode:"cors"};this.devMode||"string"!=typeof this.authKey||options.headers.set("X-Batch-Auth",this.authKey),this.devMode&&options.headers.set("X-Batch-Dev","true"),this.referrer&&options.headers.set("X-Batch-Referer",this.referrer);try{const body=await ws.getBody(this.parameterStore);options.body=JSON.stringify(body);const URL=ws.getBaseURL()+"/"+this.apiKey;_logger__WEBPACK_IMPORTED_MODULE_0__.Log.grouped(_logger__WEBPACK_IMPORTED_MODULE_0__.LogLevel.Info,"WSExecutor","Calling WS",["URL: ".concat(URL),body,options]);const response=await fetch(URL,options);if(!response.ok)throw new _http_error__WEBPACK_IMPORTED_MODULE_1__.default(response);return _logger__WEBPACK_IMPORTED_MODULE_0__.Log.grouped(_logger__WEBPACK_IMPORTED_MODULE_0__.LogLevel.Info,"WSExecutor","WS finished successfuly",["Status text: ".concat(response.statusText)]),response.json()}catch(error){throw _logger__WEBPACK_IMPORTED_MODULE_0__.Log.error("WSExecutor","Error while executing WS",error),error}}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{StandardSDK:()=>StandardSDK,default:()=>__WEBPACK_DEFAULT_EXPORT__});var com_batch_shared_helpers_array_compare__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(55),com_batch_shared_helpers_push_helper__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(56),com_batch_shared_helpers_timed_promise__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(15),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(4),_sdk_base__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(10);class StandardSDK extends _sdk_base__WEBPACK_IMPORTED_MODULE_4__.default{async setup(sdkConfig){if(await super.setup(sdkConfig),null==window)throw new Error("not in a browser page. is it a service worker?");if(!("serviceWorker"in window.navigator))throw new Error("no service worker");if(!("PushManager"in window))throw new Error("Push messaging isn't supported.");if(!sdkConfig.vapidPublicKey)throw new Error("Invalid public key");try{this.pubKey=(0,com_batch_shared_helpers_push_helper__WEBPACK_IMPORTED_MODULE_1__.urlBase64ToUint8Array)(sdkConfig.vapidPublicKey)}catch(e){throw com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.publicError("Could not decode 'vapidPublicKey'. Is it well formatted?"),new Error("Could not decode 'vapidPublicKey'. Is it well formatted?")}return await this.initServiceWorker(sdkConfig),this}async initServiceWorker(sdkConfig){if(null==window.navigator.serviceWorker)throw new Error("Browser does not support service workers");{const timeout=Math.max(10,sdkConfig.serviceWorkerTimeout||10);try{const result=await Promise.race([this.registerOrGetServiceWorker(sdkConfig),(0,com_batch_shared_helpers_timed_promise__WEBPACK_IMPORTED_MODULE_2__.Timeout)(1e3*timeout)]);result&&this.refreshInternalServiceWorkerState(result)}catch(e){if(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.error("sdk-standard","Error while initializing service worker :",e),sdkConfig.useExistingServiceWorker)com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.publicError("Timed out while waiting for the existing service worker: is your service worker properly registered?\nOriginal error: "+e);else{const swPath=this.getServiceWorkerPath(sdkConfig);com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.publicError("Failed to register the service worker. Is it accessible at '"+swPath+"'?\nOriginal error: "+e)}throw new Error("An error occurred while initializing the service worker: "+e)}}}getServiceWorkerPath(sdkConfig){let swPath="/batchsdk-worker-loader.js";return"string"==typeof sdkConfig.serviceWorkerPathOverride&&(swPath=sdkConfig.serviceWorkerPathOverride||swPath),swPath}async registerOrGetServiceWorker(sdkConfig){const swContainer=window.navigator.serviceWorker;sdkConfig.useExistingServiceWorker?com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.info("sdk-standard","Not registering Batch's SW, we have been asked to use the existing one"):await swContainer.register(this.getServiceWorkerPath(sdkConfig),{scope:"/"});const registration=await swContainer.ready;return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.info("sdk-standard","service worker ready"),registration}refreshInternalServiceWorkerState(registration){this.worker=registration.active,this.pushManager=registration.pushManager}getPushManager(){return null!=this.pushManager?Promise.resolve(this.pushManager):Promise.reject("push manager is null")}getWorker(){return null!=this.worker?Promise.resolve(this.worker):Promise.reject("worker is null")}sanitizeSubscription(subscription){if("object"==typeof subscription&&null!==subscription&&"string"==typeof subscription.endpoint)return subscription;com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.debug("sdk-standard","Invalid subscription, sanitizing. (",subscription+")")}async refreshServiceWorkerRegistration(){return this.worker=null,this.pushManager=void 0,this.initServiceWorker(this.config)}async doesExistingSubscriptionKeyMatchCurrent(){if(!window.navigator.serviceWorker)return!0;if(!this.pubKey)return!0;const registration=await window.navigator.serviceWorker.getRegistration();if(!registration)return!0;const pushManager=registration.pushManager;if(!pushManager)return!0;const subscription=await pushManager.getSubscription();if(!subscription)return!0;const currentKey=subscription.options.applicationServerKey;return!currentKey||(0,com_batch_shared_helpers_array_compare__WEBPACK_IMPORTED_MODULE_0__.compareUint8Array)(this.pubKey,new Uint8Array(currentKey))}async subscribe(){const pm=await this.getPushManager();let sub;try{sub=await pm.subscribe({applicationServerKey:this.pubKey,userVisibleOnly:!0})}catch(e){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("sdk-standard","subscription failed",e),sub=null}await this.updateSubscription(sub?sub.toJSON():null,null!=sub);return await this.isSubscribed()}async unsubscribe(){const pm=await this.getPushManager();let sub;try{sub=await pm.getSubscription()}catch(e){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("sdk-standard","unsubscription failed",e),sub=null}return this.updateSubscription(sub?sub.toJSON():null),super.unsubscribe()}async getSubscription(){var _window,_window$Notification;if("granted"!==(null===(_window=window)||void 0===_window||null===(_window$Notification=_window.Notification)||void 0===_window$Notification?void 0:_window$Notification.permission))return super.getSubscription();try{const pushManager=await this.getPushManager(),sub=await pushManager.getSubscription();return this.updateSubscription(sub?sub.toJSON():null)}catch(e){return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("sdk-standard","get subscription failed, reading it from the database. error:",e),super.getSubscription()}}}const __WEBPACK_DEFAULT_EXPORT__=new class{constructor(){this.instance=null}setup(config){if(null==this.instance){const sdkConfig=Object.assign({},config);com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.info("sdk-standard","Instantiating a new SDK");const sdk=new StandardSDK;this.instance=sdk.setup(sdkConfig).then(()=>sdk)}else com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_3__.Log.warn("sdk-standard","Config cannot be set again once the SDK has already been started");return this.instance||Promise.reject("Setup failed")}getInstance(){return this.instance||Promise.reject("You must setup the SDK before using it")}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function compareUint8Array(a,b){if(a.length!==b.length)return!1;for(let i=0;i<a.length;i++)if(a[i]!==b[i])return!1;return!0}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{compareUint8Array:()=>compareUint8Array})},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{urlBase64ToUint8Array:()=>urlBase64ToUint8Array});const urlBase64ToUint8Array=base64String=>{const base64=(base64String+"=".repeat((4-base64String.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),rawData=self.atob(base64),outputArray=new Uint8Array(rawData.length);for(let i=0;i<rawData.length;i+=1)outputArray[i]=rawData.charCodeAt(i);return outputArray}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});var com_batch_translations_translations__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(58);const comps=["button","switcher","banner","popin","alert","public-identifiers"],getTransForComponent=(languageCode,componentCode)=>{const translationsMap=(languageCode=>Object.prototype.hasOwnProperty.call(com_batch_translations_translations__WEBPACK_IMPORTED_MODULE_0__.translations,languageCode)?com_batch_translations_translations__WEBPACK_IMPORTED_MODULE_0__.translations[languageCode]:com_batch_translations_translations__WEBPACK_IMPORTED_MODULE_0__.translations.en)(languageCode);return Object.prototype.hasOwnProperty.call(translationsMap,componentCode)&&translationsMap[componentCode]||{}};class Translator{constructor(languageCode){this.lg=languageCode}setLanguage(languageCode){this.lg=languageCode}populateDefaultComponentText(uiConfig,componentCode){if(-1===comps.indexOf(componentCode))return uiConfig;const defaultTranslations=getTransForComponent(this.lg,componentCode);return uiConfig=Object.assign({},defaultTranslations,uiConfig)}}let instance=null;const __WEBPACK_DEFAULT_EXPORT__=languageCode=>(instance?languageCode&&instance.setLanguage(languageCode):instance=new Translator("string"==typeof languageCode?languageCode:navigator.language),instance)},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{translations:()=>translations});var _en__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(59),_fr__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(60);const translations={en:_en__WEBPACK_IMPORTED_MODULE_0__.translations,fr:_fr__WEBPACK_IMPORTED_MODULE_1__.translations}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{translations:()=>translations});const shared_step1="Step 1:",shared_step2="Step 2:",shared_chrome1="Click on the button to the left of the address bar",shared_chrome2="On the Notifications permission, click on Allow",shared_firefox1="Click on the bubble button to the left of the address bar",shared_firefox2='Click on the cross [x] next to "Blocked"',translations={popin:{title:"Allow notifications",btnSub:"Subscribe",btnUnsub:"Unsubscribe",step1:shared_step1,step2:shared_step2,chrome1:shared_chrome1,chrome2:shared_chrome2,firefox1:shared_firefox1,firefox2:shared_firefox2,safari1:"Click on Safari > Preferences in the top menu",safari2:"In Notifications, choose Allow for this website"},button:{hover:"Manage notifications "},banner:{text:"Never miss an update !",btnSub:"Subscribe",btnUnsub:"Unsubscribe",title:"Reactivate notifications",step1:shared_step1,step2:shared_step2,chrome1:shared_chrome1,chrome2:shared_chrome2,firefox1:shared_firefox1,firefox2:shared_firefox2},alert:{text:"Never miss an update !",positiveSubBtnLabel:"Subscribe",positiveUnsubBtnLabel:"Unsubscribe",negativeBtnLabel:"No, thanks",title:"Reactivate notifications",step1:shared_step1,step2:shared_step2,chrome1:shared_chrome1,chrome2:shared_chrome2,firefox1:shared_firefox1,firefox2:shared_firefox2},"public-identifiers":{titleLabel:"Batch SDK - Identifiers",isRegisteredLabel:"Subscribed to notifications?",closeLabel:"Close",loadingText:"Loading...",noValueText:"<No value>",errorText:"<Error>",copyLabel:"Copy",yesText:"Yes",noText:"No"}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{translations:()=>translations});const shared_step1="Etape 1:",shared_step2="Etape 2:",shared_chrome1="Cliquez sur le bouton à gauche de la barre d'adresse",shared_chrome2="Sur la permission Notifications, cliquez sur Autoriser",shared_firefox1="Cliquez sur le bouton bulle à gauche de la barre d'adresse",shared_firefox2='Cliquez sur la croix [x] à côté de "Bloqué"',translations={popin:{title:"Recevoir les notifications",btnSub:"Je m'abonne",btnUnsub:"Ne plus recevoir",step1:shared_step1,step2:shared_step2,chrome1:shared_chrome1,chrome2:shared_chrome2,firefox1:shared_firefox1,firefox2:shared_firefox2,safari1:"Cliquer sur Safari > Preferences dans le menu",safari2:"Dans Notifications, choisir Autoriser pour ce site"},button:{hover:"Gérer les notifications "},banner:{text:"Ne ratez plus jamais une nouveauté !",btnSub:"Je m'abonne",btnUnsub:"Ne plus recevoir",title:"Reactiver les notifications",step1:shared_step1,step2:shared_step2,chrome1:shared_chrome1,chrome2:shared_chrome2,firefox1:shared_firefox1,firefox2:shared_firefox2},alert:{text:"Ne ratez plus jamais une nouveauté !",positiveSubBtnLabel:"Je m'abonne",positiveUnsubBtnLabel:"Ne plus recevoir",negativeBtnLabel:"Non merci",title:"Reactiver les notifications",step1:shared_step1,step2:shared_step2,chrome1:shared_chrome1,chrome2:shared_chrome2,firefox1:shared_firefox1,firefox2:shared_firefox2},"public-identifiers":{titleLabel:"Batch SDK - Identifiants",isRegisteredLabel:"Est abonné aux notifications ?",closeLabel:"Fermer",loadingText:"Chargement...",noValueText:"<Aucune valeur>",errorText:"<Erreur>",copyLabel:"Copier",yesText:"Oui",noText:"Non"}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{UIComponentState:()=>UIComponentState,UIComponent:()=>UIComponent,UIComponentHandler:()=>UIComponentHandler});var com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),com_batch_shared_batch_error__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(36),com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(24),com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(27),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(4),_dom__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(62);const publicComponents=["button","banner","switcher","popin","alert","native"],privateComponents=["public-identifiers"],baseComponentUrl=com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__.IS_WEBPACK_DEV_SERVER?"".concat(document.location.origin,"/"):"https://".concat(com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__.SSL_SCRIPT_URL,"/").concat(com_batch_shared_config__WEBPACK_IMPORTED_MODULE_0__.SDK_VERSION,"/");let UIComponentState;!function(UIComponentState){UIComponentState[UIComponentState.UNKNOWN=0]="UNKNOWN",UIComponentState[UIComponentState.LOADING=1]="LOADING",UIComponentState[UIComponentState.LOADED=2]="LOADED"}(UIComponentState||(UIComponentState={}));class UIComponent{constructor(code,initFunction){this.code=code,this.initFunction=initFunction,this.promise=null,this.component=null,this.success=!1}ready(){return null!=this.component}initialized(){return null!=this.promise}intializing(){return this.initialized()&&!this.ready()}init(conf){if(this.initialized()&&(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.warn("ui-component-handler","The module is already initialized",this.code),this.promise instanceof Promise))return this.promise;com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.debug("ui-component-handler","Init component",this.code);const res=this.initFunction(conf),prom=res instanceof Promise?res:Promise.resolve(res);return this.promise=prom.then(r=>(this.success=!0,this.component=null==r?{}:r)).catch(e=>(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.warn("ui-component-handler","Error while initializing the component",this.code,e),this.success=!1,this.component={})),this.promise.then(()=>{this.success&&com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__.LocalEventBus.emit(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__.default.UiComponentReady,{code:this.code,component:this.component},!1)}),this.promise}}class UIComponentHandler{constructor(){this.components=new Map,this.loadingComponents=new Set,this.config=null,com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__.default.HashChanged,this.onHashChanged.bind(this))}onHashChanged(args){"#_batchsdk_show_identifiers"===args.hash&&this.showPublicIdentifiers()}add(code,initFunction){if(this.getComponentState(code)==UIComponentState.LOADED)throw new com_batch_shared_batch_error__WEBPACK_IMPORTED_MODULE_1__.default("The component "+code+" already exists");this.loadingComponents.delete(code);const component=new UIComponent(code,initFunction);return com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_4__.Log.info("ui-component-handler","Add new component",code),this.components.set(code,component),null!=this.config&&component.init(this.config[code]||{}),component}getComponent(code){return this.components.get(code)||null}getComponentState(code){return this.loadingComponents.has(code)?UIComponentState.LOADING:this.components.get(code)?UIComponentState.LOADED:UIComponentState.UNKNOWN}shouldLoadComponent(code){return this.getComponentState(code)==UIComponentState.UNKNOWN}isKnownComponent(code){return-1!==publicComponents.indexOf(code)||-1!==privateComponents.indexOf(code)}isPublicComponent(code){return-1!==publicComponents.indexOf(code)}loadNativeComponentScript(code){if(!this.shouldLoadComponent(code))return Promise.reject("Refusing to load component ".concat(code,": it is already loaded or is loading."));if(!this.isKnownComponent(code))return Promise.reject("Refusing to load component ".concat(code,": it is not part of the known loadable components"));const url="".concat(baseComponentUrl).concat(code,".min.js");return new Promise((resolve,reject)=>{const tag=document.createElement("script");tag.async=!0,tag.src=url,tag.onload=()=>resolve(!0),tag.onerror=()=>{this.loadingComponents.delete(code),reject("Loading error")},_dom__WEBPACK_IMPORTED_MODULE_5__.doc.getByTag("script").first().before(tag,!1).empty()?reject(new Error("Unable to insert the script "+url)):this.loadingComponents.add(code)})}autoLoadNativeComponents(config){const loadingPromises=Object.keys(config).filter(code=>this.isPublicComponent(code)).map(componentCode=>this.loadNativeComponentScript(componentCode));return Promise.all(loadingPromises).then(()=>Promise.resolve())}async showPublicIdentifiers(){try{await this.loadNativeComponentScript("public-identifiers")}catch(_unused){}(await this.waitUntilDrawn("public-identifiers")).show(!0)}waitUntilDrawn(componentCode){return new Promise(resolve=>{com_batch_shared_local_event_bus__WEBPACK_IMPORTED_MODULE_2__.LocalEventBus.subscribe(com_batch_shared_local_sdk_events__WEBPACK_IMPORTED_MODULE_3__.default.UiComponentDrawn,data=>{data.code===componentCode&&data.component&&resolve(data.component)})})}init(config){return this.config=config,this.autoLoadNativeComponents(config).then(()=>{const promises=[];return this.components.forEach((value,key)=>{value.initialized()||promises.push(value.init(config[key]||{}))}),Promise.all(promises)})}}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DOMElement:()=>DOMElement,dom:()=>dom,doc:()=>doc});var _size__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(63);const realHTMLElementPrototype=Object.getPrototypeOf(Object.getPrototypeOf(document.createElement("span")));function isHTMLElement(e){return Object.prototype.isPrototypeOf.call(realHTMLElementPrototype,Object.getPrototypeOf(e))}class DOMElement{constructor(elems){this.wrapped=elems}toArray(){return null!=this.doms||(this.doms=this.wrapped.map(e=>DOMElement.from(e))),this.doms}filterHTML(){return this.wrapped.filter(isHTMLElement)}filterSVG(){return this.wrapped.filter(e=>e instanceof SVGElement)}elem(){return this.wrapped[0]}elems(){return this.wrapped}is(d){const e=this.elem();return void 0!==e&&0!==d.length()&&d.someElem(el=>el===e)}concat(d){return new DOMElement(this.wrapped.concat(d.wrapped))}getById(id){return DOMElement.from(document.getElementById(id))}selectOne(selector){const a=this.wrapped.map(e=>e.querySelector(selector));return DOMElement.from(a.filter(e=>null!=e))}select(selector){const a=DOMElement.flattern(this.wrapped.map(e=>e.querySelectorAll(selector)));return DOMElement.from(a)}getByTag(tag){const a=DOMElement.flattern(this.wrapped.map(e=>e.getElementsByTagName(tag)));return DOMElement.from(a)}getByClass(className){const a=DOMElement.flattern(this.wrapped.map(e=>e.getElementsByClassName(className)));return DOMElement.from(a)}parent(){return DOMElement.from(this.wrapped.map(e=>e.parentElement).filter(e=>null!=e))}closest(selector){return DOMElement.from(this.wrapped.map(e=>e.closest(selector)).filter(e=>null!=e))}empty(){return 0===this.wrapped.length}length(){return this.wrapped.length}first(){return DOMElement.from(null!=this.doms?this.doms[0]:this.wrapped[0])}last(){return DOMElement.from(null!=this.doms?this.doms[this.wrapped.length-1]:this.wrapped[this.wrapped.length-1])}forEach(callback){return this.toArray().forEach(callback),this}forEachElem(callback){return this.wrapped.forEach(callback),this}filter(callback){return DOMElement.from(this.toArray().filter(callback).map(e=>e.elem()))}filterElem(callback){return this.wrapped.filter(callback)}some(callback){return this.toArray().some(callback)}someElem(callback){return this.wrapped.some(callback)}hasClass(className){return this.filterHTML().some(e=>e.className.split(" ").some(c=>c===className))}addClass(className){return null!==className&&this.filterHTML().forEach(e=>{e.className+=" "+className}),this}removeClass(className){return null!==className&&this.filterHTML().forEach(e=>{e.className=e.className.split(" ").filter(c=>c!==className).join(" ")}),this}html(content){return null!==content&&this.filterHTML().forEach(e=>e.innerHTML=content),this}href(content){return null!==content&&this.filterHTML().filter(e=>e instanceof HTMLAnchorElement).forEach(e=>e.href=content),this}text(content){return null!==content&&this.filterHTML().forEach(e=>{e instanceof HTMLInputElement?e.value=content:e.innerText=content}),this}placeholder(content){return null!==content&&this.filterHTML().forEach(e=>{e instanceof HTMLInputElement?e.placeholder=content:e.innerText=content}),this}listenTo(evt,callback){return null!=evt&&null!=callback&&this.wrapped.forEach(e=>e.addEventListener(evt,callback)),this}style(st){return this.filterHTML().forEach(e=>{Object.keys(st).forEach(k=>e.style[k]=st[k])}),this}styleProperty(st){return"function"==typeof CSSStyleDeclaration.prototype.setProperty&&this.filterHTML().forEach(e=>{Object.keys(st).forEach(k=>e.style.setProperty(k,st[k]))}),this}styleSVG(st){return this.filterSVG().forEach(e=>{Object.keys(st).forEach(k=>e.style[k]=st[k])}),this}rect(){const e=this.elem();return null==e?new _size__WEBPACK_IMPORTED_MODULE_0__.Rectangle(new _size__WEBPACK_IMPORTED_MODULE_0__.Position(0,0),new _size__WEBPACK_IMPORTED_MODULE_0__.Dimension(0,0)):(0,_size__WEBPACK_IMPORTED_MODULE_0__.sizeOfElement)(e)}dim(){const e=this.elem();return void 0===e?new _size__WEBPACK_IMPORTED_MODULE_0__.Dimension(0,0):(0,_size__WEBPACK_IMPORTED_MODULE_0__.sizeOfElement)(e).dim}isFixed(){let e=this.elem();for(;e&&!(e instanceof HTMLElement);)e=e.parentElement;if(null==e)return!1;for(;null!=e;){if("fixed"===window.getComputedStyle(e).position)return!0;e=e.offsetParent}return!1}before(newElem,clone){const a=this.wrapped.map(e=>null!=e.parentNode?e.parentNode.insertBefore(clone?newElem.cloneNode(!0):newElem,e):null);return DOMElement.from(a.filter(e=>null!=e))}append(newElem,clone){const a=this.wrapped.map(e=>e.appendChild(clone?newElem.cloneNode(!0):newElem));return DOMElement.from(a.filter(e=>null!=e))}prepend(newElem,clone){const a=this.wrapped.map(e=>{const ne=clone?newElem.cloneNode(!0):newElem;if("function"==typeof e.prepend)e.prepend(ne);else{const docFrag=document.createDocumentFragment();docFrag.appendChild(ne instanceof Node?ne:document.createTextNode(String(ne))),e.insertBefore(docFrag,e.firstChild)}return ne});return DOMElement.from(a.filter(e=>null!=e))}static flattern(a){return 0===a.length?[]:a.reduce((acc,val)=>acc.concat(Array.from(val)),[])}static from(ne){if(null==ne)return DOMElement.EMPTY;const e=ne;if("string"==typeof e)return DOMElement.from(document.querySelectorAll(e));if("object"==typeof e){if(e instanceof Array||e instanceof NodeList){const elements=[];for(let i=0;i<e.length;i++){const node=e[i];node instanceof Element&&elements.push(node)}return new DOMElement(elements)}if(e instanceof DOMElement)return e;if(e instanceof Element)return new DOMElement([e]);if(e instanceof HTMLCollection)return new DOMElement(Array.from(e))}return DOMElement.EMPTY}}var obj,key,value;function dom(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];if(0===args.length)return DOMElement.EMPTY;if(1===args.length)return DOMElement.from(args[0]);let d=DOMElement.EMPTY;return args.forEach(e=>d=d.concat(DOMElement.from(e))),d}obj=DOMElement,key="EMPTY",value=new DOMElement([]),key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value;const doc={getById:id=>dom(document.getElementById(id)),getByTag:tag=>dom(document.getElementsByTagName(tag)),getByClass:className=>dom(document.getElementsByClassName(className)),selectOne:selector=>dom(document.querySelector(selector)),select:selector=>dom(document.querySelectorAll(selector)),body:()=>dom(document.body)}},(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Position:()=>Position,Dimension:()=>Dimension,Rectangle:()=>Rectangle,screenPos:()=>screenPos,screenDim:()=>screenDim,windowDim:()=>windowDim,windowBox:()=>windowBox,fromClientRect:()=>fromClientRect,sizeOfElement:()=>sizeOfElement});class Position{constructor(left,top){this.left=left,this.top=top}toString(){return"left="+this.left+"px,top="+this.top+"px"}asStyle(){return{left:this.left+"px",top:this.top+"px"}}}class Dimension{constructor(width,height){this.width=width,this.height=height}centerIn(box){const dim=box.dim,pos=box.pos,l=this.width<dim.width?dim.width/2-this.width/2:0,t=this.height<dim.height?dim.height/2-this.height/2:0;return new Position(l+pos.left,t+pos.top)}toString(){return"width="+this.width+"px,height="+this.height+"px"}}class Rectangle{constructor(pos,dim){this.pos=pos,this.dim=dim}toString(){return this.pos.toString()+","+this.dim.toString()}top(){return this.pos.top}left(){return this.pos.left}right(){return this.pos.left+this.dim.width}bottom(){return this.pos.top+this.dim.height}width(){return this.dim.width}height(){return this.dim.height}}function screenPos(){return void 0===window.screenLeft||void 0===window.screenTop?new Position(window.screenX,window.screenY):new Position(window.screenLeft,window.screenTop)}function screenDim(){return new Dimension(screen.width,screen.height)}function windowDim(){if(window.innerWidth||window.innerHeight)return new Dimension(window.innerWidth,window.innerHeight);if(null!=document.documentElement){const el=document.documentElement;if(el.clientWidth&&el.clientHeight)return new Dimension(el.clientWidth,el.clientHeight)}return screenDim()}function windowBox(){return new Rectangle(screenPos(),windowDim())}function fromClientRect(rect){const pos=new Position(rect.left,rect.top),dim=new Dimension(rect.right-rect.left,rect.bottom-rect.top);return new Rectangle(pos,dim)}function sizeOfElement(element){return fromClientRect(element.getBoundingClientRect())}}],__webpack_module_cache__={};function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(void 0!==cachedModule)return cachedModule.exports;var module=__webpack_module_cache__[moduleId]={exports:{}};return __webpack_modules__[moduleId](module,module.exports,__webpack_require__),module.exports}__webpack_require__.d=(exports,definition)=>{for(var key in definition)__webpack_require__.o(definition,key)&&!__webpack_require__.o(exports,key)&&Object.defineProperty(exports,key,{enumerable:!0,get:definition[key]})},__webpack_require__.o=(obj,prop)=>Object.prototype.hasOwnProperty.call(obj,prop),__webpack_require__.r=exports=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{__webpack_require__.r(__webpack_exports__);var com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4),_config__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_public_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6);com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.name="SDK",_config__WEBPACK_IMPORTED_MODULE_1__.IS_DEV&&(com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.level=com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.LogLevel.Debug,com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.enableModule("*"),com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.disableModule("local-bus"));!function(w){const api=(0,_public_api__WEBPACK_IMPORTED_MODULE_2__.default)();function execute(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];if(0===args.length)return void com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.warn("boostrap","No arguments given");let mArgs=null;args[0]instanceof Array&&(mArgs=args[0],args=args.slice(1));let result,callback=null;if(args.length>0&&("function"==typeof args[0]?(args.length>1&&com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.warn("boostrap","No arguments expected after a callback"),callback=args[0]):null==mArgs&&(mArgs=args)),null!=mArgs)if("string"!=typeof mArgs[0])com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.warn("boostrap","No message name given");else{const message=mArgs[0];let msg=message,who=api;mArgs=mArgs.slice(1),msg.startsWith("ui.")&&(msg=msg.substring(3),who=api.ui),who[msg]?result=who[msg].apply(api,mArgs):com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.warn("boostrap","Unknown message",message)}callback&&callback(api,result)}const queue=w.batchSDK&&w.batchSDK.q||[];if(Array.isArray(queue)){let job;for(w.batchSDK=function(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];return queue.push(args)};job=queue.shift();)execute.apply(w,job);w.batchSDK=function(){for(var _len3=arguments.length,args=new Array(_len3),_key3=0;_key3<_len3;_key3++)args[_key3]=arguments[_key3];return execute.apply(w,args)}}const devToolApi=w["_com.batchsdk.web.devtool.api"];if(devToolApi){com_batch_shared_logger__WEBPACK_IMPORTED_MODULE_0__.Log.warn("boostrap","Enabling devtool support");const oldSDK=w.batchSDK;"function"==typeof devToolApi.sdkCalled&&(w.batchSDK=function(){for(var _len4=arguments.length,args=new Array(_len4),_key4=0;_key4<_len4;_key4++)args[_key4]=arguments[_key4];devToolApi.sdkCalled.apply(w,args),oldSDK.apply(w,args)}),"function"==typeof devToolApi.setSdkApi&&devToolApi.setSdkApi((function(){for(var _len5=arguments.length,args=new Array(_len5),_key5=0;_key5<_len5;_key5++)args[_key5]=arguments[_key5];oldSDK.apply(w,args)})),"function"==typeof devToolApi.sdkLoaded&&devToolApi.sdkLoaded()}}(window)})()})();